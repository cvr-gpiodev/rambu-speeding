Q<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SPEEDING ALERT - Device Monitoring</title>  
  <style>  
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0c0d10;
      color: #eee;
      margin: 14px;
      font-size: 14px;
    }
    
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #3b82f6;
    }
    
    /* ============ NAVIGATION ============ */
    .nav-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2a2d35;
    }
    
    .nav-button {
      background: #1a1d24;
      color: #ccc;
      border: 1px solid #2a2d35;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .nav-button:hover {
      background: #2a2d35;
    }
    
    .nav-button.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    /* ============ CARD STYLES ============ */
    .card {
      background: #15161a;
      border: 1px solid #2a2d35;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #2a2d35;
    }
    
    /* ============ BUTTON STYLES ============ */
    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    
    .btn:hover {
      background: #2563eb;
    }
    
    .btn-success {
      background: #22c55e;
    }
    
    .btn-success:hover {
      background: #16a34a;
    }
    
    .btn-danger {
      background: #ef4444;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    /* ============ TABLE STYLES ============ */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #2a2d35;
      border-radius: 6px;
      margin-top: 12px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    th, td {
      border: 1px solid #2a2d35;
      padding: 8px;
      text-align: left;
    }
    
    thead th {
      position: sticky;
      top: 0;
      background: #15161a;
      z-index: 10;
      border-bottom: 2px solid #2a2d35;
      font-weight: 600;
    }
    
    tbody tr:hover {
      background: #1a1d24;
    }
    
    /* ============ STATUS BADGES ============ */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-align: center;
      min-width: 70px;
    }
    
    .status-online {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid #22c55e;
    }
    
    .status-offline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid #ef4444;
    }
    
    .status-waiting {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid #f59e0b;
    }
    
    /* ============ DEVICE FORM ============ */
    .device-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: #1a1d24;
      border-radius: 6px;
      border: 1px solid #2a2d35;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .form-label {
      font-size: 12px;
      color: #aaa;
    }
    
    .form-select {
      background: #0f1115;
      border: 1px solid #2a2d35;
      color: #eee;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 13px;
      width: 100%;
    }
    
    /* ============ DEVICE LIST ============ */
    .device-list-empty {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    
    /* ============ NOTIFICATION ============ */
    .notify {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: #22c55e;
      color: white;
      border-radius: 6px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .notify.error {
      background: #ef4444;
    }
    
    .last-seen {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }
    
    /* ============ CONFIG SECTION ============ */
    .config-card {
      background: #1a1d24;
      border: 1px solid #2a2d35;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .config-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #3b82f6;
    }
    
    .config-input {
      background: #0f1115;
      border: 1px solid #2a2d35;
      color: #eee;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 13px;
      width: 100%;
      margin-bottom: 8px;
      font-family: monospace;
    }
    
    .config-help {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>

<body>  
  <div class="nav-container">
    <a href="index.html" class="nav-button">üìä Data Rambu</a>
    <a href="devices.html" class="nav-button active">üì° Device Monitor</a>
  </div>
  
  <h2>üì° DEVICE MONITORING</h2>
  
  <!-- GITHUB CONFIGURATION -->
  <div class="config-card">
    <div class="config-title">üîß GitHub Configuration</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
      <div>
        <input type="text" id="githubUser" class="config-input" placeholder="GitHub Username" value="fahruldev">
        <div class="config-help">Your GitHub username</div>
      </div>
      <div>
        <input type="text" id="githubRepo" class="config-input" placeholder="Repository Name" value="rambu-database">
        <div class="config-help">Repository name</div>
      </div>
    </div>
    <div>
      <input type="password" id="githubToken" class="config-input" placeholder="GitHub Personal Access Token">
      <div class="config-help">Get token from GitHub Settings ‚Üí Developer Settings</div>
    </div>
    <div style="margin-top: 8px; display: flex; gap: 8px;">
      <button onclick="saveGitHubConfig()" class="btn btn-success">üíæ Save Config</button>
      <button onclick="testGitHubConnection()" class="btn">üîó Test Connection</button>
    </div>
  </div>
  
  <!-- ADD DEVICE FORM -->
  <div class="card">
    <div class="card-header">
      <h3 style="margin:0">‚ûï Add New Device</h3>
    </div>
    
    <div class="device-form">
      <div class="form-group">
        <label class="form-label">Device ID</label>
        <select id="deviceIdSelect" class="form-select">
          <option value="">Select Device ID</option>
          <option value="SPD-ALRT001">SPD-ALRT001</option>
          <option value="SPD-ALRT002">SPD-ALRT002</option>
          <option value="SPD-ALRT003">SPD-ALRT003</option>
          <option value="SPD-ALRT004">SPD-ALRT004</option>
          <option value="SPD-ALRT005">SPD-ALRT005</option>
          <option value="SPD-ALRT006">SPD-ALRT006</option>
          <option value="SPD-ALRT007">SPD-ALRT007</option>
          <option value="SPD-ALRT008">SPD-ALRT008</option>
          <option value="SPD-ALRT009">SPD-ALRT009</option>
          <option value="SPD-ALRT010">SPD-ALRT010</option>
        </select>
      </div>
      
      <div class="form-group" style="align-self: flex-end;">
        <button onclick="addDevice()" class="btn btn-success">‚ûï Add Device</button>
      </div>
    </div>
    
    <div style="font-size:11px;color:#666;margin-top:8px">
      <strong>Note:</strong> Device must be registered here before ESP32 can send status.
    </div>
  </div>
  
  <!-- DEVICE TABLE -->
  <div class="card">
    <div class="card-header">
      <h3 style="margin:0">üìã Registered Devices</h3>
      <div>
        <button onclick="refreshAllDevices()" class="btn">üîÑ Refresh All</button>
        <button onclick="clearAllDevices()" class="btn btn-danger">üóëÔ∏è Clear All</button>
        <button onclick="checkAllDevicesUpdate()" class="btn">üì° Check Updates</button>
      </div>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th width="25%">Device</th>
            <th width="20%">Status</th>
            <th width="20%">Connection</th>
            <th width="25%">Last Updated</th>
            <th width="10%">Actions</th>
          </tr>
        </thead>
        <tbody id="deviceTableBody">
          <!-- Devices will appear here -->
        </tbody>
      </table>
    </div>
    
    <div id="emptyMessage" class="device-list-empty" style="display:none">
      No devices registered. Add devices using the form above.
    </div>
  </div>
  
  <!-- NOTIFICATION -->
  <div id="notify" class="notify"></div>

  <script>
// ============ KONFIGURASI GITHUB ============
let GITHUB_USER = 'cvr-gpiodev';
let GITHUB_REPO = 'rambu-speeding';
let GITHUB_TOKEN = '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';
const GITHUB_API = 'https://api.github.com';

// ============ VARIABLES ============
let registeredDevices = [];

// ============ LOAD CONFIGURATION ============
function loadConfig() {
  const config = localStorage.getItem('github_config');
  if (config) {
    const { user, repo, token } = JSON.parse(config);
    GITHUB_USER = user || '';
    GITHUB_REPO = repo || '';
    GITHUB_TOKEN = token || '';
    
    // Update input fields
    document.getElementById('githubUser').value = GITHUB_USER;
    document.getElementById('githubRepo').value = GITHUB_REPO;
    document.getElementById('githubToken').value = GITHUB_TOKEN;
  }
}

function saveGitHubConfig() {
  const user = document.getElementById('githubUser').value.trim();
  const repo = document.getElementById('githubRepo').value.trim();
  const token = document.getElementById('githubToken').value.trim();
  
  if (!user || !repo) {
    showNotify('GitHub Username and Repository are required', false);
    return;
  }
  
  GITHUB_USER = user;
  GITHUB_REPO = repo;
  GITHUB_TOKEN = token;
  
  const config = { user, repo, token };
  localStorage.setItem('github_config', JSON.stringify(config));
  
  showNotify('GitHub configuration saved successfully');
}

async function testGitHubConnection() {
  if (!GITHUB_USER || !GITHUB_REPO) {
    showNotify('Please save configuration first', false);
    return;
  }
  
  try {
    // Test connection to version file
    const response = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    
    if (response.ok) {
      const version = await response.text();
      showNotify(`‚úÖ Connected! Current version: ${version.trim()}`);
    } else {
      showNotify('‚ùå Cannot connect to repository. Check your configuration.', false);
    }
  } catch (error) {
    showNotify(`‚ùå Connection failed: ${error.message}`, false);
  }
}

// ============ FUNGSI UNTUK UPDATE VERSION DI GITHUB ============
async function updateVersionOnGitHub(deviceId) {
  if (!GITHUB_USER || !GITHUB_REPO || !GITHUB_TOKEN) {
    console.log('GitHub configuration missing');
    return null;
  }
  
  try {
    // Get current version
    const versionResponse = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    
    let currentVersion = 1;
    if (versionResponse.ok) {
      const versionText = await versionResponse.text();
      currentVersion = parseInt(versionText.trim()) || 1;
    }
    
    const newVersion = currentVersion + 1;
    
    // Get SHA of version file
    const shaResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    if (!shaResponse.ok) {
      throw new Error('Failed to get file SHA');
    }
    
    const shaData = await shaResponse.json();
    const sha = shaData.sha;
    
    // Update version file
    const updateResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Device ${deviceId} updated data - v${newVersion}`,
          content: btoa(String(newVersion)),
          sha: sha
        })
      }
    );
    
    if (!updateResponse.ok) {
      throw new Error('Failed to update version');
    }
    
    console.log(`‚úÖ Version updated to ${newVersion} for ${deviceId}`);
    return newVersion;
    
  } catch (error) {
    console.error('‚ùå Error updating version:', error);
    return null;
  }
}

// ============ LOAD SAVED DEVICES ============
function loadDevices() {
  const saved = localStorage.getItem('registered_devices');
  if (saved) {
    registeredDevices = JSON.parse(saved);
  }
  updateDeviceTable();
}

// ============ SAVE DEVICES ============
function saveDevices() {
  localStorage.setItem('registered_devices', JSON.stringify(registeredDevices));
}

// ============ ADD NEW DEVICE ============
function addDevice() {
  const deviceId = document.getElementById('deviceIdSelect').value;
  
  if (!deviceId) {
    showNotify('Please select a Device ID', false);
    return;
  }
  
  // Check if device already exists
  if (registeredDevices.some(device => device.id === deviceId)) {
    showNotify(`Device ${deviceId} already exists`, false);
    return;
  }
  
  // Add new device
  const newDevice = {
    id: deviceId,
    status: 'waiting',
    connection: 'offline',
    lastSeen: null,
    lastUpdate: null,
    dataVersion: 0,
    added: new Date().toISOString()
  };
  
  registeredDevices.push(newDevice);
  saveDevices();
  
  // Clear form
  document.getElementById('deviceIdSelect').value = '';
  
  showNotify(`Device ${deviceId} registered successfully`);
  updateDeviceTable();
}

// ============ UPDATE DEVICE STATUS ============
async function updateDeviceStatus(deviceId, statusData) {
  // Find device
  const deviceIndex = registeredDevices.findIndex(d => d.id === deviceId);
  if (deviceIndex === -1) {
    console.log(`Device ${deviceId} not registered`);
    return false;
  }
  
  // Update status
  const now = new Date();
  const device = registeredDevices[deviceIndex];
  
  // Update connection status (online/offline)
  device.connection = 'online';
  device.lastSeen = now.toISOString();
  
  // Update device status (updated/waiting)
  if (statusData.status_type === 'data_updated') {
    device.status = 'updated';
    device.lastUpdate = now.toISOString();
    
    // Update version in GitHub
    const newVersion = await updateVersionOnGitHub(deviceId);
    if (newVersion) {
      device.dataVersion = newVersion;
      device.message = `Updated to v${newVersion}`;
    }
    
  } else if (statusData.status_type === 'online') {
    device.status = 'updated';
    device.lastUpdate = now.toISOString();
    device.message = statusData.message || 'Device online';
  } else {
    device.message = statusData.message || 'Status update';
  }
  
  saveDevices();
  updateDeviceTable();
  
  console.log(`Status updated for ${deviceId}`);
  return true;
}

// ============ CHECK FOR UPDATES ============
async function checkDeviceUpdate(deviceId) {
  if (!GITHUB_USER || !GITHUB_REPO) {
    showNotify('GitHub configuration required', false);
    return;
  }
  
  try {
    const response = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    
    if (response.ok) {
      const versionText = await response.text();
      const currentVersion = parseInt(versionText.trim()) || 1;
      
      const deviceIndex = registeredDevices.findIndex(d => d.id === deviceId);
      if (deviceIndex !== -1) {
        const device = registeredDevices[deviceIndex];
        
        if (currentVersion > device.dataVersion) {
          device.dataVersion = currentVersion;
          device.status = 'updated';
          device.lastUpdate = new Date().toISOString();
          device.message = `Data v${currentVersion} available`;
          
          saveDevices();
          updateDeviceTable();
          
          showNotify(`Device ${deviceId} has new data v${currentVersion}`);
        } else {
          showNotify(`Device ${deviceId} is up to date (v${currentVersion})`);
        }
      }
    }
  } catch (error) {
    showNotify(`Failed to check updates: ${error.message}`, false);
  }
}

function checkAllDevicesUpdate() {
  registeredDevices.forEach(device => {
    checkDeviceUpdate(device.id);
  });
}

// ============ UPDATE DEVICE TABLE ============
function updateDeviceTable() {
  const tbody = document.getElementById('deviceTableBody');
  const emptyMsg = document.getElementById('emptyMessage');
  
  if (registeredDevices.length === 0) {
    tbody.innerHTML = '';
    emptyMsg.style.display = 'block';
    return;
  }
  
  emptyMsg.style.display = 'none';
  
  let html = '';
  const now = new Date();
  
  registeredDevices.forEach(device => {
    const lastSeen = device.lastSeen ? new Date(device.lastSeen) : null;
    const lastUpdate = device.lastUpdate ? new Date(device.lastUpdate) : null;
    
    // Determine connection badge
    let connectionBadge = 'status-offline';
    let connectionText = 'Offline';
    
    if (lastSeen) {
      const minutesAgo = Math.floor((now - lastSeen) / 60000);
      
      if (minutesAgo < 3) {
        connectionBadge = 'status-online';
        connectionText = 'Online';
      } else if (minutesAgo < 10) {
        connectionBadge = 'status-waiting';
        connectionText = 'Waiting';
      }
    }
    
    // Determine status badge
    let statusBadge = 'status-waiting';
    let statusText = 'Waiting';
    let lastUpdateText = 'Never';
    
    if (lastUpdate) {
      const updateMinutesAgo = Math.floor((now - lastUpdate) / 60000);
      
      if (updateMinutesAgo < 5) {
        statusBadge = 'status-online';
        statusText = 'Updated';
      }
      lastUpdateText = `${updateMinutesAgo} min ago`;
    }
    
    // Add data version info
    const versionInfo = device.dataVersion > 0 ? `v${device.dataVersion}` : 'No data';
    
    html += `
      <tr>
        <td>
          <strong>${device.id}</strong><br>
          <small style="color:#666;font-size:10px">${versionInfo}</small>
        </td>
        <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
        <td><span class="status-badge ${connectionBadge}">${connectionText}</span></td>
        <td>
          ${lastUpdateText}<br>
          <small class="last-seen">Last seen: ${lastSeen ? Math.floor((now - lastSeen)/60000) + ' min ago' : 'Never'}</small>
          ${device.message ? `<br><small style="color:#3b82f6;font-size:10px">${device.message}</small>` : ''}
        </td>
        <td>
          <button onclick="testDevice('${device.id}')" class="btn" style="padding:4px 8px;font-size:11px;margin-bottom:2px">Test</button>
          <button onclick="checkDeviceUpdate('${device.id}')" class="btn" style="padding:4px 8px;font-size:11px;margin-bottom:2px">Check Update</button>
          <button onclick="removeDevice('${device.id}')" class="btn btn-danger" style="padding:4px 8px;font-size:11px">Remove</button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

// ============ REMOVE DEVICE ============
function removeDevice(deviceId) {
  if (confirm(`Remove device ${deviceId} from monitoring?`)) {
    registeredDevices = registeredDevices.filter(d => d.id !== deviceId);
    saveDevices();
    updateDeviceTable();
    showNotify(`Device ${deviceId} removed`);
  }
}

// ============ TEST DEVICE ============
function testDevice(deviceId) {
  // Simulate test connection
  const mockData = {
    device_id: deviceId,
    status_type: 'heartbeat',
    message: 'Test connection',
    timestamp: new Date().toISOString()
  };
  
  if (updateDeviceStatus(deviceId, mockData)) {
    showNotify(`Test connection sent to ${deviceId}`);
  }
}

// ============ REFRESH ALL DEVICES ============
function refreshAllDevices() {
  // Check for stale devices
  const now = new Date();
  let updatedCount = 0;
  
  registeredDevices.forEach(device => {
    if (device.lastSeen) {
      const minutesAgo = Math.floor((now - new Date(device.lastSeen)) / 60000);
      
      if (minutesAgo > 10) {
        device.connection = 'offline';
        updatedCount++;
      }
    }
  });
  
  saveDevices();
  updateDeviceTable();
  showNotify(`Refreshed ${updatedCount} devices`);
}

// ============ CLEAR ALL DEVICES ============
function clearAllDevices() {
  if (confirm('Clear all registered devices? This cannot be undone.')) {
    registeredDevices = [];
    saveDevices();
    updateDeviceTable();
    showNotify('All devices cleared');
  }
}

// ============ SIMULATE INCOMING STATUS ============
function simulateIncomingStatus() {
  if (registeredDevices.length === 0) return;
  
  // Pick random device
  const randomDevice = registeredDevices[Math.floor(Math.random() * registeredDevices.length)];
  const statusTypes = ['heartbeat', 'data_updated', 'online'];
  const statusType = statusTypes[Math.floor(Math.random() * statusTypes.length)];
  
  const mockData = {
    device_id: randomDevice.id,
    status_type: statusType,
    message: statusType === 'data_updated' ? 'Data updated to v' + (Math.floor(Math.random() * 5) + 1) : 'Status update',
    timestamp: new Date().toISOString()
  };
  
  updateDeviceStatus(randomDevice.id, mockData);
}

// ============ WEBHOOK HANDLER (Simulation) ============
function setupWebhookListener() {
  // Simulate incoming status every 30 seconds
  setInterval(() => {
    if (registeredDevices.length > 0 && Math.random() > 0.7) {
      simulateIncomingStatus();
    }
  }, 30000);
}

// ============ MANUAL STATUS UPDATE (for testing) ============
function manualStatusUpdate(deviceId, statusType) {
  const mockData = {
    device_id: deviceId,
    status_type: statusType,
    message: 'Manual update',
    timestamp: new Date().toISOString()
  };
  
  if (updateDeviceStatus(deviceId, mockData)) {
    showNotify(`Manual ${statusType} update for ${deviceId}`);
  }
}

// ============ NOTIFICATION ============
function showNotify(message, isSuccess = true) {
  const notify = document.getElementById('notify');
  notify.textContent = message;
  notify.className = isSuccess ? 'notify' : 'notify error';
  notify.style.display = 'block';
  
  setTimeout(() => {
    notify.style.display = 'none';
  }, 3000);
}

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', function() {
  // Load configurations
  loadConfig();
  loadDevices();
  
  setupWebhookListener();
  
  // Auto-refresh table every 5 seconds
  setInterval(updateDeviceTable, 5000);
  
  // Add test device if empty
  if (registeredDevices.length === 0) {
    const testDevice = {
      id: 'SPD-ALRT001',
      status: 'updated',
      connection: 'online',
      lastSeen: new Date().toISOString(),
      lastUpdate: new Date().toISOString(),
      dataVersion: 1,
      message: 'Test device',
      added: new Date().toISOString()
    };
    
    registeredDevices.push(testDevice);
    saveDevices();
    updateDeviceTable();
  }
});

// ============ GLOBAL FUNCTIONS FOR ESP32 TO CALL ============
window.receiveDeviceStatus = function(deviceId, statusType, message) {
  const mockData = {
    device_id: deviceId,
    status_type: statusType,
    message: message,
    timestamp: new Date().toISOString()
  };
  
  return updateDeviceStatus(deviceId, mockData);
};

window.getRegisteredDevices = function() {
  return registeredDevices.map(d => d.id);
};

// Example: ESP32 can call: receiveDeviceStatus('SPD-ALRT001', 'online', 'Device connected')
  </script>
</body>
</html>
