<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DATA RAMBU SPEEDING ALERT</title>  
  <style>  
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0c0d10;
      color: #eee;
      margin: 14px;
      font-size: 14px;
    }
    
    h2 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #3b82f6;
    }
    
    h3 {
      font-size: 14px;
      margin-bottom: 6px;
      color: #ddd;
    }
    
    /* ============ CARD STYLES ============ */
    .card {
      background: #15161a;
      border: 1px solid #2a2d35;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
    }
    
    .row-container {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .card-small {
      flex: 1;
      min-width: 300px;
    }
    
    /* ============ DEVICE MONITORING STYLES ============ */
    .device-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    
    .device-card {
      background: #1a1d24;
      border: 1px solid #2a2d35;
      border-radius: 6px;
      padding: 8px;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .device-card:hover {
      background: #1f2229;
    }
    
    .device-card.online {
      border-left: 4px solid #22c55e;
    }
    
    .device-card.warning {
      border-left: 4px solid #f59e0b;
    }
    
    .device-card.offline {
      border-left: 4px solid #ef4444;
      opacity: 0.7;
    }
    
    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid #2a2d35;
    }
    
    .device-id {
      font-weight: bold;
      color: #3b82f6;
    }
    
    .status-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      background: #2a2d35;
      font-weight: bold;
    }
    
    .device-card.online .status-badge {
      background: #22c55e;
      color: white;
    }
    
    .device-card.warning .status-badge {
      background: #f59e0b;
      color: white;
    }
    
    .device-card.offline .status-badge {
      background: #ef4444;
      color: white;
    }
    
    .device-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      font-size: 11px;
      color: #aaa;
    }
    
    .device-details div {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .device-message {
      grid-column: 1 / -1;
      background: rgba(59, 130, 246, 0.1);
      padding: 4px;
      border-radius: 4px;
      margin-top: 4px;
      font-style: italic;
      color: #8bb9ff;
    }
    
    .last-seen {
      color: #888;
      font-size: 10px;
      text-align: right;
      margin-top: 4px;
    }
    
    /* ============ TABLE STYLES ============ */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #2a2d35;
      border-radius: 4px;
      margin-top: 8px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    th, td {
      border: 1px solid #2a2d35;
      padding: 2.4px;
      text-align: left;
    }
    
    thead th {
      position: sticky;
      top: 0;
      background: #15161a;
      z-index: 10;
      border-bottom: 2px solid #2a2d35;
    }
    
    td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ============ INPUT & BUTTON STYLES ============ */
    input, button, select {
      padding: 2.4px 4.8px;
      margin: 1.2px;
      font-size: 13.2px;
    }
    
    input, select {
      width: 100%;
      box-sizing: border-box;
      background: #0f1115;
      border: 1px solid #2a2d35;
      color: #eee;
      border-radius: 4px;
      padding: 2.4px;
    }
    
    .coord {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 8px;
    }
    
    /* ============ BUTTON VARIANTS ============ */
    .btn-test {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 1.2px 4.8px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-stop {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 1.2px 4.8px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 2.4px;
    }
    
    .btn-save {
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 1.2px 4.8px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-delete {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 1.2px 4.8px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 2.4px;
    }
    
    .btn-reset {
      background: #f59e0b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 1.2px 4.8px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 2.4px;
    }
    
    /* ============ SERIAL MONITOR STYLES ============ */
    .serial-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #15161a;
      border-top: 1px solid #2a2d35;
      padding: 6px;
      z-index: 1000;
      height: 140px;
    }
    
    .serial {
      background: #000;
      color: #0f0;
      padding: 6px;
      border-radius: 2px;
      font-family: monospace;
      font-size: 13px;
      height: 70px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 5px;
    }
    
    .serial-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* ============ NOTIFICATION STYLES ============ */
    .notify {
      position: fixed;
      bottom: 130px;
      right: 20px;
      padding: 8px 14px;
      background: #22c55e;
      color: #fff;
      border-radius: 8px;
      display: none;
      z-index: 1000;
    }
    
    .blink {
      animation: blink 0.5s linear 3;
    }
    
    @keyframes blink {
      50% { opacity: 0; }
    }
    
    /* ============ FILTER STYLES ============ */
    .filter-container {
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-label {
      font-size: 12px;
    }
    
    /* ============ JALUR STYLES ============ */
    .jalur-muatan {
      border-left: 4px solid #888 !important;
    }
    
    .jalur-kosongan {
      border-left: 4px solid #3b82f6 !important;
    }
    
    .jalur-luar {
      border-left: 4px solid #ef4444 !important;
    }
    
    /* ============ ACTIVE ROW STYLES ============ */
    .active-row {
      background-color: #2a3b4c !important;
    }
    
    /* ============ STATISTICS STYLES ============ */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    
    .stat-card {
      background: #1a1d24;
      border-radius: 6px;
      padding: 6px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #3b82f6;
    }
    
    .stat-label {
      font-size: 10px;
      color: #aaa;
      margin-top: 2px;
    }
    
    /* ============ MISC STYLES ============ */
    .content {
      margin-bottom: 140px;
    }
    
    .coord-input {
      width: 120px;
      font-size: 11px;
    }
    
    .longlat-container {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    
    .longlat-input {
      flex: 1;
      min-width: 80px;
    }
    
    .area-input {
      width: 180px;
    }
    
    .mp3-test-container {
      display: flex;
      gap: 4.8px;
      align-items: center;
      margin: 4.8px 0;
    }
    
    .k {
      display: flex;
      gap: 4.8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 4.8px;
    }
    
    .mp3-desc-container {
      display: flex;
      gap: 4.8px;
      align-items: center;
      margin-top: 2.4px;
    }
    
    .mp3-desc-input {
      flex: 1;
      margin-bottom: 0;
      font-size: 12px;
    }
  </style>
</head>

<body>  
  <h2>DATA RAMBU SPEEDING ALERT - Device Monitoring</h2>  
  <div class="coord" id="coord">Koordinat: -</div>  

  <!-- DEVICE MONITORING SECTION -->
  <div class="row-container">
    <div class="card card-small">  
      <h3>üì° Device Status Monitor</h3>  
      <div class="k">  
        <button class="btn-test" onclick="refreshDeviceStatus()">üîÑ Refresh Status</button>
        <button class="btn-test" onclick="clearDeviceLogs()">üóëÔ∏è Clear Logs</button>
        <span id="deviceCount" style="font-size:12px;color:#aaa">Devices: 0</span>  
      </div>
      
      <!-- Device Statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-value" id="statOnline">0</div>
          <div class="stat-label">Online</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statOffline">0</div>
          <div class="stat-label">Offline</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statUpdated">0</div>
          <div class="stat-label">Updated</div>
        </div>
      </div>
      
      <!-- Device List -->
      <div id="deviceStatusContainer">
        <div class="device-list">
          <div class="device-card offline">
            <div class="device-header">
              <span class="device-id">No devices connected</span>
              <span class="status-badge">Offline</span>
            </div>
            <div class="device-details">
              <div>Waiting for ESP32 connection...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- TIDAK ADA LAGI GPS SECTION DI SINI -->
    
    <div class="card">  
      <div class="k">  
        <button onclick="exportCSV()">Export CSV</button>  
        <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(this)">  
        <button onclick="document.getElementById('importFile').click()">Import CSV</button>  
        <button class="btn-save" onclick="addRow()">+ Add Row</button>
        <button class="btn-test" onclick="calculateAutoRadius()">auto distance CP</button>
        <button class="btn-test" onclick="saveAll()">Save All</button>
      </div>  
      
      <div class="filter-container">
        <span class="filter-label">Filter Jalur:</span>
        <select id="filterJalur" onchange="filterTable()">
          <option value="all">Semua Jalur</option>
          <option value="0">Muatan</option>
          <option value="1">Kosongan</option>
          <option value="2">Luar Area</option>
        </select>
      </div>
      
      <div class="table-container">
        <table>  
          <thead><tr>  
            <th>#</th><th>Longitude</th><th>Latitude</th><th>Nama Area</th>  
            <th>Overspeed km/jam</th><th>Radius</th><th>Jalur</th><th>MP3 Track</th><th>Checkpoint</th><th>1xmp3</th><th>Enabled</th><th>Actions</th>  
          </tr></thead>  
          <tbody id="tableBody"></tbody>  
        </table>  
      </div>
    </div>  
  </div>

  <!-- TIDAK ADA LAGI GPS MODAL -->

  <!-- SERIAL MONITOR -->
  <div class="serial-container">  
    <h3>üìù System Log</h3>  
    <div class="serial" id="serial">msg:Sistem Ready\nmsg:Device Monitor Active</div>  
    <div class="serial-controls">
      <span id="logStatus">Status: Active</span>
      <button onclick="clearSerial()">Clear Log</button>
    </div>
  </div>  

  <!-- NOTIFICATION -->
  <div id="notify" class="notify"></div>  

  <script>
// ============ KONFIGURASI GITHUB ============
const GITHUB_USER = 'cvr-gpiodev';  // GANTI!
const GITHUB_REPO = 'rambu-speeding';  // GANTI!
const GITHUB_TOKEN = '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';  // GANTI!
const GITHUB_API = 'https://api.github.com';

// ============ VARIABEL GLOBAL ============
let rambuData = [];
let currentGPS = { lon: 117.49389, lat: -2.153491, fix: true };
let currentActiveRow = -1;
let systemLog = ["msg:Sistem Ready", "msg:Device Monitor Active"];
let logInterval;
let deviceStatus = {};

// ============ DEVICE MONITORING FUNCTIONS ============
function refreshDeviceStatus() {
  updateDeviceStatusDisplay();
  addLog("Device status refreshed");
  showNotify("Device status refreshed", true);
}

function clearDeviceLogs() {
  if (confirm("Clear all device logs?")) {
    localStorage.removeItem('rambu_devices');
    deviceStatus = {};
    updateDeviceStatusDisplay();
    addLog("Device logs cleared");
    showNotify("Device logs cleared", true);
  }
}

// Save device status to localStorage
function saveDeviceStatus(deviceId, status) {
  let devices = JSON.parse(localStorage.getItem('rambu_devices') || '{}');
  
  devices[deviceId] = {
    ...status,
    last_seen: new Date().toISOString(),
    timestamp: new Date().getTime()
  };
  
  localStorage.setItem('rambu_devices', JSON.stringify(devices));
  deviceStatus = devices;
  
  updateDeviceStatusDisplay();
  addLog(`Device ${deviceId} status updated: ${status.status_type || 'heartbeat'}`);
}

// Update device status display
function updateDeviceStatusDisplay() {
  const devices = JSON.parse(localStorage.getItem('rambu_devices') || '{}');
  const container = document.getElementById('deviceStatusContainer');
  const now = new Date().getTime();
  
  if (!container) return;
  
  let html = '';
  let onlineCount = 0;
  let offlineCount = 0;
  let updatedCount = 0;
  
  if (Object.keys(devices).length === 0) {
    html = `
      <div class="device-list">
        <div class="device-card offline">
          <div class="device-header">
            <span class="device-id">No devices connected</span>
            <span class="status-badge">Offline</span>
          </div>
          <div class="device-details">
            <div>Waiting for ESP32 connection...</div>
          </div>
          <div class="last-seen">Last check: Just now</div>
        </div>
      </div>
    `;
  } else {
    html = '<div class="device-list">';
    
    Object.entries(devices).forEach(([deviceId, data]) => {
      const lastSeen = new Date(data.last_seen);
      const minutesAgo = Math.floor((now - data.timestamp) / 60000);
      
      let statusClass = 'offline';
      let statusText = 'Offline';
      
      if (minutesAgo < 2) {
        statusClass = 'online';
        statusText = 'Online';
        onlineCount++;
      } else if (minutesAgo < 5) {
        statusClass = 'warning';
        statusText = 'Warning';
        onlineCount++;
      } else {
        offlineCount++;
      }
      
      if (data.status_type === 'data_updated') {
        updatedCount++;
      }
      
      html += `
        <div class="device-card ${statusClass}">
          <div class="device-header">
            <span class="device-id">${deviceId}</span>
            <span class="status-badge">${statusText}</span>
          </div>
          <div class="device-details">
            <div><strong>Data:</strong> v${data.data_version || 0}</div>
            <div><strong>Rambu:</strong> ${data.rambu_count || 0}</div>
            <div><strong>IP:</strong> ${data.ip_address || 'N/A'}</div>
            <div><strong>RSSI:</strong> ${data.rssi || 'N/A'} dBm</div>
            ${data.message ? `<div class="device-message">${data.message}</div>` : ''}
          </div>
          <div class="last-seen">Last seen: ${minutesAgo} minute${minutesAgo !== 1 ? 's' : ''} ago</div>
        </div>
      `;
    });
    
    html += '</div>';
  }
  
  // Update statistics
  document.getElementById('statOnline').textContent = onlineCount;
  document.getElementById('statOffline').textContent = offlineCount;
  document.getElementById('statTotal').textContent = Object.keys(devices).length;
  document.getElementById('statUpdated').textContent = updatedCount;
  document.getElementById('deviceCount').textContent = `Devices: ${Object.keys(devices).length} (${onlineCount} online)`;
  
  container.innerHTML = html;
}

// Simulate incoming webhook (for testing)
function simulateWebhook() {
  const testDevices = ['ESP001', 'ESP002', 'ESP003'];
  const deviceId = testDevices[Math.floor(Math.random() * testDevices.length)];
  const statusTypes = ['online', 'heartbeat', 'data_updated', 'error'];
  const statusType = statusTypes[Math.floor(Math.random() * statusTypes.length)];
  
  const mockData = {
    device_id: deviceId,
    status_type: statusType,
    message: statusType === 'data_updated' 
      ? `Updated from v${Math.floor(Math.random() * 5)} to v${Math.floor(Math.random() * 10)}`
      : statusType === 'online' 
      ? 'Device connected successfully'
      : statusType === 'error'
      ? 'GPS signal lost'
      : 'Regular heartbeat',
    data_version: Math.floor(Math.random() * 10),
    rambu_count: Math.floor(Math.random() * 20) + 10,
    ip_address: `192.168.1.${Math.floor(Math.random() * 255)}`,
    rssi: -Math.floor(Math.random() * 40) - 50,
    timestamp: new Date().toISOString()
  };
  
  saveDeviceStatus(deviceId, mockData);
  addLog(`Simulated webhook from ${deviceId}: ${statusType}`);
}

// ============ WEBHOOK HANDLER (Simulasi) ============
function setupWebhookListener() {
  // Simulate incoming webhooks every 30 seconds
  setInterval(() => {
    if (Math.random() > 0.7) { // 30% chance of receiving a webhook
      simulateWebhook();
    }
  }, 30000);
  
  // Also check for stale devices every minute
  setInterval(() => {
    const devices = JSON.parse(localStorage.getItem('rambu_devices') || '{}');
    const now = new Date().getTime();
    
    Object.keys(devices).forEach(deviceId => {
      const lastUpdate = devices[deviceId].timestamp;
      const minutesSinceUpdate = Math.floor((now - lastUpdate) / 60000);
      
      if (minutesSinceUpdate > 10 && devices[deviceId].status_type !== 'offline') {
        devices[deviceId].status_type = 'offline';
        devices[deviceId].message = 'Device timeout - No signal for 10+ minutes';
        localStorage.setItem('rambu_devices', JSON.stringify(devices));
        updateDeviceStatusDisplay();
      }
    });
  }, 60000);
}

// ============ NOTIFICATION FUNCTIONS ============
function showNotify(msg, isSuccess=true){  
  const n=document.getElementById('notify'); 
  n.textContent=msg;  
  n.style.background=isSuccess?'#22c55e':'#ef4444'; 
  n.style.display='block'; 
  n.classList.add('blink');  
  setTimeout(()=>{ 
    n.style.display='none'; 
    n.classList.remove('blink'); 
  },2000); 
}

// ============ HAVERSINE DISTANCE CALCULATION ============
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// ============ AUTO RADIUS CALCULATION ============
function calculateAutoRadius() {
  const rows = document.querySelectorAll('#tableBody tr');
  const rambuByJalur = {0: [], 1: []};
  
  rows.forEach((row, index) => {
    const jalurSelect = row.cells[6].querySelector('select');
    const jalur = parseInt(jalurSelect.value);
    
    if (jalur === 0 || jalur === 1) {
      const lonInput = row.cells[1].querySelector('input');
      const latInput = row.cells[2].querySelector('input');
      const checkpointInput = row.cells[8].querySelector('input');
      
      const lon = parseFloat(lonInput.value);
      const lat = parseFloat(latInput.value);
      const checkpoint = parseInt(checkpointInput.value);
      
      if (!isNaN(lon) && !isNaN(lat)) {
        rambuByJalur[jalur].push({
          rowIndex: index,
          row: row,
          lon: lon,
          lat: lat,
          checkpoint: checkpoint
        });
      }
    }
  });
  
  for (const jalur in rambuByJalur) {
    const rambus = rambuByJalur[jalur];
    
    rambus.sort((a, b) => a.checkpoint - b.checkpoint);
    
    for (let i = 0; i < rambus.length; i++) {
      let radius = 2000;
      
      if (i < rambus.length - 1) {
        const next = rambus[i + 1];
        const distance = haversineDistance(
          rambus[i].lat, rambus[i].lon,
          next.lat, next.lon
        );
        
        radius = Math.max(20, Math.min(3000, distance));
      }
      
      const radiusInput = rambus[i].row.cells[5].querySelector('input');
      radiusInput.value = Math.round(radius);
    }
  }
  
  showNotify('Radius otomatis dihitung: Jarak ke checkpoint berikutnya');
  addLog('Auto radius calculated');
}

// ============ SAVE ALL FUNCTION ============
function saveAll() {
  const rows = document.querySelectorAll('#tableBody tr');
  let savedCount = 0;
  
  rows.forEach((row, index) => {
    const saveBtn = row.querySelector('.btn-save');
    if (saveBtn) {
      saveBtn.click();
      savedCount++;
    }
  });
  
  showNotify(`${savedCount} rambu data saved.`);
  addLog(`Saved ${savedCount} rambu entries`);
}

// ============ ACTIVE ROW FUNCTIONS ============
function setActiveRow(rowIndex) {
  document.querySelectorAll('#tableBody tr').forEach(tr => {
    tr.classList.remove('active-row');
  });
  
  if (rowIndex >= 0) {
    const rows = document.querySelectorAll('#tableBody tr');
    if (rowIndex < rows.length) {
      rows[rowIndex].classList.add('active-row');
      currentActiveRow = rowIndex;
    }
  }
}

// ============ LOAD DATA FUNCTION ============
async function loadData(){  
  try{ 
    const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`);
    const data = await response.json();
    rambuData = data.rambu || [];
    
    if (rambuData.length > 0) {
      // Set GPS coordinate display from first rambu
      const firstRambu = rambuData[0];
      document.getElementById('coord').textContent = 
        `Koordinat: ${Math.abs(firstRambu.lat).toFixed(6)}, ${Math.abs(firstRambu.lon).toFixed(6)}`;
    }
    
    renderTable(); 
    addLog('Data rambu loaded: ' + rambuData.length + ' entries');
  } catch(e) {
    console.error(e);
    addLog('Error loading data: ' + e.message);
    showNotify('Failed to load data', false);
  } 
}  

// ============ FILTER TABLE FUNCTION ============
function filterTable() {
  const filterValue = document.getElementById('filterJalur').value;
  const rows = document.querySelectorAll('#tableBody tr');
  
  rows.forEach(row => {
    const jalurSelect = row.cells[6].querySelector('select');
    const jalurValue = jalurSelect ? jalurSelect.value : '0';
    
    if (filterValue === 'all' || jalurValue === filterValue) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ============ RENDER TABLE FUNCTION ============
function renderTable(){  
  const body = document.getElementById('tableBody'); 
  body.innerHTML = '';  
  rambuData.forEach((r,i)=>{ 
    const tr = document.createElement('tr');  
    tr.onclick = () => setActiveRow(i);
    
    const jalurClass = r.jalur === 0 ? 'jalur-muatan' : r.jalur === 1 ? 'jalur-kosongan' : 'jalur-luar';
    tr.className = jalurClass;
    
    const inp=(v,t='text')=>{
      const x=document.createElement('input');
      x.value=v;
      x.type=t;
      return x;
    };
    
    const coordInp=(v,className)=>{
      const x=document.createElement('input');
      x.value=v;
      x.type='text';
      x.className=className;
      return x;
    };
    
    const sel=(options, selected)=>{
      const s=document.createElement('select'); 
      options.forEach(opt=>{  
        const o=document.createElement('option'); 
        o.value=opt.value; 
        o.textContent=opt.text;  
        if(opt.value==selected) o.selected=true; 
        s.appendChild(o); 
      }); 
      return s; 
    };  
    
    const chk=(checked)=>{
      const c=document.createElement('input'); 
      c.type='checkbox'; 
      c.checked=checked; 
      return c; 
    };  
    
    const tdNo=document.createElement('td');
    tdNo.textContent=i+1;
    tr.appendChild(tdNo);
    
    const tdLon=document.createElement('td');
    const inLon=coordInp(r.lon.toFixed(6),'lon-input longlat-input');
    inLon.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    tdLon.appendChild(inLon);
    tr.appendChild(tdLon);
    
    const tdLat=document.createElement('td');
    const inLat=coordInp(r.lat.toFixed(6),'lat-input longlat-input');
    inLat.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    tdLat.appendChild(inLat);
    tr.appendChild(tdLat);
    
    const inArea=inp(r.nama);
    inArea.className='area-input';
    inArea.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inLimit=inp(r.limit,'number'); 
    inLimit.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inRad=inp(r.radius,'number');
    inRad.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inCheckpoint=inp(r.checkpoint,'number');
    inCheckpoint.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const selJalur=sel([
      {value:0,text:'Muatan'}, 
      {value:1,text:'Kosongan'}, 
      {value:2,text:'Luar Area'}
    ], r.jalur);  
    
    selJalur.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const trackOptions = Array.from({length:50},(_,i)=>({ 
      value: i+1, 
      text: (i+1) + ' - Track ' + (i+1) 
    }));  
    
    const selMp3=sel(trackOptions, r.mp3Track || 1); 
    selMp3.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const chkOneTime=chk(r.oneTimeMP3 || false); 
    chkOneTime.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const chkEnabled=chk(r.enabled);
    chkEnabled.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const saveBtn=document.createElement('button'); 
    saveBtn.className='btn-save'; 
    saveBtn.textContent='Save';  
    saveBtn.onclick=async(e)=>{ 
      e.stopPropagation();
      const row={ 
        lon:parseFloat(inLon.value)||0, 
        lat:parseFloat(inLat.value)||0,  
        nama:inArea.value||'',  
        limit:parseInt(inLimit.value)||0, 
        radius:parseInt(inRad.value)||0, 
        jalur:parseInt(selJalur.value)||0, 
        enabled:chkEnabled.checked,  
        mp3Track:parseInt(selMp3.value)||1, 
        checkpoint:parseInt(inCheckpoint.value)||(i+1), 
        oneTimeMP3:chkOneTime.checked 
      };  
      
      await saveRambuToGitHub(i, row);
      rambuData = await loadRambuFromGitHub();
      renderTable(); 
      showNotify('Rambu saved');
      addLog('Saved rambu: ' + row.nama);
    };  
    
    const delBtn=document.createElement('button'); 
    delBtn.className='btn-delete'; 
    delBtn.textContent='Delete';  
    delBtn.onclick=async(e)=>{ 
      e.stopPropagation();
      if(confirm('Delete this rambu?')){ 
        await deleteRambuFromGitHub(i);
        rambuData = await loadRambuFromGitHub();
        renderTable(); 
        showNotify('Rambu deleted'); 
        addLog('Deleted rambu: ' + r.nama);
      } 
    };  
    
    const tdActions=document.createElement('td'); 
    tdActions.onclick = (e) => e.stopPropagation();
    tdActions.appendChild(saveBtn); 
    tdActions.appendChild(delBtn);  
    
    const cells = [
      inArea, inLimit, inRad, selJalur, selMp3, inCheckpoint, chkOneTime, chkEnabled, tdActions
    ];
    
    cells.forEach(el=>{  
      const td=document.createElement('td');
      td.appendChild(el);
      tr.appendChild(td); 
    }); 
    
    body.appendChild(tr); 
  }); 
      
  if (rambuData.length > 0 && currentActiveRow === -1) {
    setActiveRow(0);
  }
  filterTable();
}  

// ============ GITHUB API FUNCTIONS ============
async function loadRambuFromGitHub() {
  try {
    const response = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`
    );
    const data = await response.json();
    return data.rambu || [];
  } catch (error) {
    console.error('Error loading from GitHub:', error);
    return [];
  }
}

async function getFileSHA() {
  try {
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    const data = await response.json();
    return data.sha;
  } catch (error) {
    console.error('Error getting SHA:', error);
    return null;
  }
}

async function saveRambuToGitHub(index, rambu) {
  try {
    if (index === -1) {
      rambuData.push(rambu);
    } else {
      rambuData[index] = rambu;
    }
    
    const sha = await getFileSHA();
    if (!sha) {
      throw new Error('Failed to get file SHA');
    }
    
    const githubData = {
      rambu: rambuData,
      last_updated: new Date().toISOString(),
      total_count: rambuData.length
    };
    
    const content = btoa(JSON.stringify(githubData, null, 2));
    
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Update rambu ${index === -1 ? 'added' : 'modified'}: ${rambu.nama}`,
          content: content,
          sha: sha
        })
      }
    );
    
    if (!response.ok) {
      throw new Error('GitHub API error');
    }
    
    await updateVersion();
    
    return true;
  } catch (error) {
    console.error('Error saving to GitHub:', error);
    showNotify('Failed to save to GitHub', false);
    return false;
  }
}

async function deleteRambuFromGitHub(index) {
  try {
    rambuData.splice(index, 1);
    
    const sha = await getFileSHA();
    if (!sha) {
      throw new Error('Failed to get file SHA');
    }
    
    const githubData = {
      rambu: rambuData,
      last_updated: new Date().toISOString(),
      total_count: rambuData.length
    };
    
    const content = btoa(JSON.stringify(githubData, null, 2));
    
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Delete rambu at index ${index}`,
          content: content,
          sha: sha
        })
      }
    );
    
    if (!response.ok) {
      throw new Error('GitHub API error');
    }
    
    await updateVersion();
    
    return true;
  } catch (error) {
    console.error('Error deleting from GitHub:', error);
    showNotify('Failed to delete from GitHub', false);
    return false;
  }
}

async function updateVersion() {
  try {
    const versionResponse = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    let currentVersion = 1;
    
    if (versionResponse.ok) {
      const versionText = await versionResponse.text();
      currentVersion = parseInt(versionText.trim()) || 1;
    }
    
    const newVersion = currentVersion + 1;
    
    const shaResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    const shaData = await shaResponse.json();
    const sha = shaData.sha;
    
    await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Update to version ${newVersion}`,
          content: btoa(String(newVersion)),
          sha: sha
        })
      }
    );
    
    addLog(`Version updated to ${newVersion}`);
    
    // Simulate device update notification
    const devices = JSON.parse(localStorage.getItem('rambu_devices') || '{}');
    Object.keys(devices).forEach(deviceId => {
      if (Math.random() > 0.5) { // 50% chance device will update
        setTimeout(() => {
          const updateData = {
            device_id: deviceId,
            status_type: 'data_updated',
            message: `Updated from v${currentVersion} to v${newVersion}`,
            data_version: newVersion,
            rambu_count: rambuData.length,
            ip_address: devices[deviceId].ip_address || '192.168.1.100',
            rssi: -65,
            timestamp: new Date().toISOString()
          };
          saveDeviceStatus(deviceId, updateData);
        }, Math.random() * 5000);
      }
    });
    
  } catch (error) {
    console.error('Error updating version:', error);
  }
}

// ============ ADD ROW FUNCTION ============
function addRow(){ 
  const newIndex = rambuData.length;
  const newRow = {
    lon: 117.49389,
    lat: -2.153491,
    nama: 'New Area ' + (newIndex + 1),
    limit: 30,
    radius: 100,
    jalur: 0,
    enabled: true,
    mp3Track: 1,
    checkpoint: newIndex + 1,
    oneTimeMP3: false
  };
  
  rambuData.push(newRow);
  renderTable();
  setActiveRow(newIndex);
  showNotify('New row added');
  addLog('Added new row');
}  

// ============ EXPORT CSV FUNCTION ============
function exportCSV(){  
  let csv = 'longitude,latitude,area,limit_kph,radius_m,jalur,mp3_track,checkpoint,one_time_mp3,enabled\n';
  
  rambuData.forEach(rambu => {
    csv += `${rambu.lon},${rambu.lat},${rambu.nama},${rambu.limit},${rambu.radius},`;
    csv += `${rambu.jalur},${rambu.mp3Track || 1},${rambu.checkpoint},`;
    csv += `${rambu.oneTimeMP3 ? '1' : '0'},${rambu.enabled ? '1' : '0'}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rambu_data_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotify('CSV Exported');
  addLog('Exported CSV file');
}  

// ============ IMPORT CSV FUNCTION ============
async function importCSV(input){  
  const file = input.files[0];  
  if(!file) return;  
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const csvText = e.target.result;
    
    try {
      const lines = csvText.split('\n');
      const newRambuData = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const fields = line.split(',');
        if (fields.length >= 6) {
          const rambu = {
            lon: parseFloat(fields[0]) || 0,
            lat: parseFloat(fields[1]) || 0,
            nama: fields[2] || 'Unknown',
            limit: parseInt(fields[3]) || 30,
            radius: parseInt(fields[4]) || 100,
            jalur: parseInt(fields[5]) || 0,
            mp3Track: fields.length > 6 ? parseInt(fields[6]) || 1 : 1,
            checkpoint: fields.length > 7 ? parseInt(fields[7]) || 1 : 1,
            oneTimeMP3: fields.length > 8 ? (fields[8] === '1' || fields[8].toLowerCase() === 'true') : false,
            enabled: fields.length > 9 ? (fields[9] === '1' || fields[9].toLowerCase() === 'true') : true
          };
          newRambuData.push(rambu);
        }
      }
      
      if (newRambuData.length > 0) {
        rambuData = newRambuData;
        
        const sha = await getFileSHA();
        const githubData = {
          rambu: rambuData,
          last_updated: new Date().toISOString(),
          total_count: rambuData.length
        };
        
        const content = btoa(JSON.stringify(githubData, null, 2));
        
        await fetch(
          `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${GITHUB_TOKEN}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Import CSV: ${newRambuData.length} rambu`,
              content: content,
              sha: sha
            })
          }
        );
        
        await updateVersion();
        renderTable();
        showNotify(`Imported ${newRambuData.length} rambu from CSV`);
        addLog(`Imported ${newRambuData.length} rambu from CSV`);
      }
    } catch (error) {
      console.error('Import error:', error);
      showNotify('Import failed', false);
      addLog('Import failed: ' + error.message);
    }
  };
  
  reader.readAsText(file);
  input.value = '';
}  

// ============ SYSTEM LOG FUNCTIONS ============
function addLog(message) {
  const timestamp = new Date().toLocaleTimeString();
  systemLog.push(`[${timestamp}] ${message}`);
  
  if (systemLog.length > 10) {
    systemLog.shift();
  }
  
  updateSerialDisplay();
}

function updateSerialDisplay() {
  const serialDiv = document.getElementById('serial');
  serialDiv.textContent = systemLog.join('\n');
  serialDiv.scrollTop = serialDiv.scrollHeight;
  
  // Update log status
  const logStatus = document.getElementById('logStatus');
  const devices = JSON.parse(localStorage.getItem('rambu_devices') || '{}');
  const onlineCount = Object.values(devices).filter(d => {
    const minutesAgo = Math.floor((new Date().getTime() - d.timestamp) / 60000);
    return minutesAgo < 5;
  }).length;
  
  logStatus.textContent = `Status: ${Object.keys(devices).length} devices (${onlineCount} online)`;
}

function clearSerial() {
  systemLog = ['msg:Log cleared'];
  updateSerialDisplay();
  addLog('System log cleared');
}

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', function() {
  // Load initial data
  loadData();
  
  // Initialize device monitoring
  setupWebhookListener();
  updateDeviceStatusDisplay();
  
  // Initialize log
  updateSerialDisplay();
  
  // Auto-update displays
  logInterval = setInterval(updateSerialDisplay, 1000);
  setInterval(updateDeviceStatusDisplay, 5000);
  
  // Add initial logs
  addLog('System initialized');
  addLog('Device monitoring active');
  addLog('Waiting for ESP32 connections...');
  
  // Add some simulated devices for demo
  setTimeout(() => {
    simulateWebhook();
    setTimeout(simulateWebhook, 2000);
    setTimeout(simulateWebhook, 4000);
  }, 1000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  if (logInterval) {
    clearInterval(logInterval);
  }
});
  </script>  
</body>
</html>
