<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DATA RAMBU SPEEDING ALERT</title>  
<style>  
body{font-family:Segoe UI,Arial;background:#0c0d10;color:#eee;margin:14px;font-size:14px}  
h2{font-size:18px;margin-bottom:8px}  
.card{background:#15161a;border:1px solid #2a2d35;border-radius:8px;padding:8px;margin-bottom:8px}  
.row-container{display:flex;gap:8px;margin-bottom:8px}  
.card-small{flex:1;min-width:0}  
.card-small h3{font-size:14px;margin-bottom:6px}  
.card-small .k{margin-bottom:0}  
.card-small .mp3-test-container{flex-wrap:wrap}  
.table-container{max-height:400px;overflow-y:auto;border:1px solid #2a2d35;border-radius:4px;margin-top:8px}  
table{width:100%;border-collapse:collapse;font-size:12px}  
th,td{border:1px solid #2a2d35;padding:2.4px;text-align:left}  
input,button,select{padding:2.4px 4.8px;margin:1.2px;font-size:13.2px}  
.coord{font-size:12px;color:#aaa;margin-bottom:8px}  
.serial-container{position:fixed;bottom:0;left:0;right:0;background:#15161a;border-top:1px solid #2a2d35;padding:6px;z-index:1000;height:140px}  
.serial{background:#000;color:#0f0;padding:6px;border-radius:2px;font-family:monospace;font-size:13px;height:70px;overflow-y:auto;white-space:pre-wrap;margin-bottom:5px}  
.serial-controls{display:flex;justify-content:space-between;align-items:center}  
.notify{position:fixed;bottom:130px;right:20px;padding:8px 14px;background:#22c55e;color:#fff;border-radius:8px;display:none;z-index:1000}  
.blink{animation:blink 0.5s linear 3}  
@keyframes blink{50%{opacity:0}}  
.btn-test{background:#3b82f6;color:white;border:none;border-radius:4px;padding:1.2px 4.8px;cursor:pointer;font-size:12px}  
.btn-stop{background:#ef4444;color:white;border:none;border-radius:4px;padding:1.2px 4.8px;cursor:pointer;font-size:12px;margin-left:2.4px}  
.btn-save{background:#22c55e;color:white;border:none;border-radius:4px;padding:1.2px 4.8px;cursor:pointer;font-size:12px}  
.btn-delete{background:#ef4444;color:white;border:none;border-radius:4px;padding:1.2px 4.8px;cursor:pointer;font-size:12px;margin-left:2.4px}  
.btn-reset{background:#f59e0b;color:white;border:none;border-radius:4px;padding:1.2px 4.8px;cursor:pointer;font-size:12px;margin-left:2.4px}  
.mp3-test-container{display:flex;gap:4.8px;align-items:center;margin:4.8px 0}  
.k{display:flex;gap:4.8px;flex-wrap:wrap;align-items:center;margin-bottom:4.8px}  
input,select{width:100%;box-sizing:border-box;background:#0f1115;border:1px solid #2a2d35;color:#eee;border-radius:4px;padding:2.4px}  
.mp3-desc-container{display:flex;gap:4.8px;align-items:center;margin-top:2.4px}  
.mp3-desc-input{flex:1;margin-bottom:0;font-size:12px}  
.content{margin-bottom:140px}  
thead th {position: sticky;top: 0;background: #15161a;z-index: 10;border-bottom: 2px solid #2a2d35;}  
td {white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}  
.coord-input{width:120px;font-size:11px}  
.coord-btn{font-size:11px;padding:1px 3px}  
.longlat-container{display:flex;gap:2px;align-items:center}  
.longlat-input{flex:1;min-width:80px}  
.area-input{width:180px}  
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6)}  
.modal-content{background:#15161a;margin:8% auto;padding:16px;border:1px solid #2a2d35;border-radius:8px;width:90%;max-width:400px;color:#eee}  
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #2a2d35}  
.modal-title{font-size:16px;font-weight:bold}  
.close-modal{background:none;border:none;color:#eee;font-size:20px;cursor:pointer}  
.modal-body{padding:8px 0}  
.modal-gps-info{background:#0f1115;padding:8px;border-radius:4px;margin-bottom:12px;font-size:12px}  
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}  
.btn-modal{background:#3b82f6;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;font-size:12px}  
.btn-modal-cancel{background:#6b7280}  
.btn-modal-confirm{background:#22c55e}  
.coord-display{font-family:monospace;background:#000;padding:4px;border-radius:2px;margin:4px 0}  
.active-row{background-color:#2a3b4c !important}  
.jalur-muatan{border-left:4px solid #888 !important}  
.jalur-kosongan{border-left:4px solid #3b82f6 !important}  
.jalur-luar{border-left:4px solid #ef4444 !important}  
.aktif-indicator{position:absolute;left:0;top:0;width:100%;height:100%;background:rgba(255,255,255,0.1);animation:blink 1s infinite;pointer-events:none;border-radius:2px}  
.filter-container{margin:8px 0;display:flex;align-items:center;gap:8px}  
.filter-label{font-size:12px}  
.ovspd-indicator{background:rgba(255,50,50,0.2) !important;animation:pulse 0.8s infinite}  
@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:0.8}}  
</style></head><body>  
<h2>SPEEDING ALERT</h2>  
<div class="coord" id="coord">Koordinat: -</div>  

<div class="content">
  <div class="row-container">
    <div class="card card-small">  
      <h3>GPS</h3>  
      <div class="k">  
        <button class="btn-test" onclick="showGPSCoordModal()">ðŸ“¡ Gunakan Koordinat GPS Saat Ini</button>  
        <span id="gpsStatus" style="font-size:12px;color:#aaa">GPS: Menunggu data...</span>  
      </div>  
    </div>  
  </div>
  
  <div class="card">  
    <div class="k">  
      <button onclick="exportCSV()">Export CSV</button>  
      <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(this)">  
      <button onclick="document.getElementById('importFile').click()">Import CSV</button>  
      <button class="btn-save" onclick="addRow()">+ Add Row</button>
      <button class="btn-test" onclick="calculateAutoRadius()">auto distance CP</button>
      <button class="btn-test" onclick="saveAll()">Save All</button>
    </div>  
    
    <div class="filter-container">
      <span class="filter-label">Filter Jalur:</span>
      <select id="filterJalur" onchange="filterTable()">
        <option value="all">Semua Jalur</option>
        <option value="0">Muatan</option>
        <option value="1">Kosongan</option>
        <option value="2">Luar Area</option>
      </select>
    </div>
    
    <div class="table-container">
      <table>  
        <thead><tr>  
          <th>#</th><th>Longitude</th><th>Latitude</th><th>Nama Area</th>  
          <th>Overspeed km/jam</th><th>Radius</th><th>Jalur</th><th>MP3 Track</th><th>Checkpoint</th><th>1xmp3</th><th>Enabled</th><th>Actions</th>  
        </tr></thead>  
        <tbody id="tableBody"></tbody>  
      </table>  
    </div>
  </div>  
</div>

<div id="gpsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ðŸ“¡ Gunakan Koordinat GPS Saat Ini</div>
      <button class="close-modal" onclick="closeGPSCoordModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-gps-info">
        <strong>Koordinat GPS Terkini:</strong>
        <div class="coord-display" id="modalCurrentCoord">-</div>
        <div id="modalGPSStatus" style="font-size:11px;color:#aaa">Memuat data GPS...</div>
      </div>
      <div>
        <strong>Pilih cara pengisian:</strong>
        <div style="margin-top:8px">
          <input type="radio" id="fillActiveRow" name="fillType" value="activeRow" checked>
          <label for="fillActiveRow">Baris yang sedang aktif</label>
        </div>
        <div>
          <input type="radio" id="fillBoth" name="fillType" value="both">
          <label for="fillBoth">Semua input longitude & latitude yang kosong</label>
        </div>
        <div id="activeRowInfo" style="margin-top:8px;padding:8px;background:#1a1d24;border-radius:4px;font-size:11px;display:none">
          <strong>Baris aktif:</strong> <span id="activeRowNumber">  </span>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-modal btn-modal-cancel" onclick="closeGPSCoordModal()">Batal</button>
      <button class="btn-modal btn-modal-confirm" onclick="applyGPSCoordinates()">Terapkan Koordinat</button>
    </div>
  </div>
</div>

<div class="serial-container">  
  <h3>System Log</h3>  
  <div class="serial" id="serial">msg:Sistem Ready</div>  
  <div class="serial-controls">
    <span>System Status</span>
    <button onclick="clearSerial()">Clear Log</button>
  </div>
</div>  

<div id="notify" class="notify"></div>  

<script>
// ============ KONFIGURASI GITHUB ============
const GITHUB_USER = 'cvr-gpiodev';  // GANTI!
const GITHUB_REPO = 'rambu-speeding';  // GANTI!
const GITHUB_TOKEN = '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';  // GANTI!
const GITHUB_API = 'https://api.github.com';

// ============ VARIABEL GLOBAL ============
let rambuData = [];
let currentGPS = { lon: 117.49389, lat: -2.153491, fix: true };
let currentActiveRow = -1;
let currentOverspeed = false;
let systemLog = ["msg:Sistem Ready", "msg:GitHub Pages Loaded"];
let logInterval;

// ============ FUNGSI NOTIFIKASI ============
function showNotify(msg, isSuccess=true){  
  const n=document.getElementById('notify'); 
  n.textContent=msg;  
  n.style.background=isSuccess?'#22c55e':'#ef4444'; 
  n.style.display='block'; 
  n.classList.add('blink');  
  setTimeout(()=>{ 
    n.style.display='none'; 
    n.classList.remove('blink'); 
  },2000); 
}

// ============ FUNGSI GPS ============
function setCurrentGPS(lon, lat, fix) {
  currentGPS.lon = lon;
  currentGPS.lat = lat;
  currentGPS.fix = fix;
  
  const gpsStatus = document.getElementById('gpsStatus');
  if (fix) {
    gpsStatus.innerHTML = 'ðŸ“ GPS: ' + lat.toFixed(6) + ', ' + lon.toFixed(6);
    gpsStatus.style.color = '#22c55e';
  } else {
    gpsStatus.innerHTML = 'âŒ GPS: Tidak ada sinyal';
    gpsStatus.style.color = '#ef4444';
  }
  
  document.getElementById('coord').textContent = 
    'Koordinat: ' + Math.abs(lat).toFixed(6) + ', ' + Math.abs(lon).toFixed(6);
}

// ============ FUNGSI HITUNG JARAK ============
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// ============ FUNGSI AUTO RADIUS ============
function calculateAutoRadius() {
  const rows = document.querySelectorAll('#tableBody tr');
  const rambuByJalur = {0: [], 1: []};
  
  rows.forEach((row, index) => {
    const jalurSelect = row.cells[6].querySelector('select');
    const jalur = parseInt(jalurSelect.value);
    
    if (jalur === 0 || jalur === 1) {
      const lonInput = row.cells[1].querySelector('input');
      const latInput = row.cells[2].querySelector('input');
      const checkpointInput = row.cells[8].querySelector('input');
      
      const lon = parseFloat(lonInput.value);
      const lat = parseFloat(latInput.value);
      const checkpoint = parseInt(checkpointInput.value);
      
      if (!isNaN(lon) && !isNaN(lat)) {
        rambuByJalur[jalur].push({
          rowIndex: index,
          row: row,
          lon: lon,
          lat: lat,
          checkpoint: checkpoint
        });
      }
    }
  });
  
  for (const jalur in rambuByJalur) {
    const rambus = rambuByJalur[jalur];
    
    rambus.sort((a, b) => a.checkpoint - b.checkpoint);
    
    for (let i = 0; i < rambus.length; i++) {
      let radius = 2000;
      
      if (i < rambus.length - 1) {
        const next = rambus[i + 1];
        const distance = haversineDistance(
          rambus[i].lat, rambus[i].lon,
          next.lat, next.lon
        );
        
        radius = Math.max(20, Math.min(3000, distance));
      }
      
      const radiusInput = rambus[i].row.cells[5].querySelector('input');
      radiusInput.value = Math.round(radius);
    }
  }
  
  showNotify('Radius otomatis dihitung: Jarak ke checkpoint berikutnya');
}

// ============ FUNGSI SAVE ALL ============
function saveAll() {
  const rows = document.querySelectorAll('#tableBody tr');
  rows.forEach((row, index) => {
    const saveBtn = row.querySelector('.btn-save');
    if (saveBtn) {
      saveBtn.click();
    }
  });
  showNotify('Semua data rambu disimpan.');
}

// ============ FUNGSI ACTIVE ROW ============
function setActiveRow(rowIndex) {
  document.querySelectorAll('#tableBody tr').forEach(tr => {
    tr.classList.remove('active-row');
  });
  
  if (rowIndex >= 0) {
    const rows = document.querySelectorAll('#tableBody tr');
    if (rowIndex < rows.length) {
      rows[rowIndex].classList.add('active-row');
      currentActiveRow = rowIndex;
      
      document.getElementById('activeRowInfo').style.display = 'block';
      document.getElementById('activeRowNumber').textContent = 
        'Baris #' + (rowIndex + 1) + ' - ' + (rambuData[rowIndex]?.area || 'No Area');
    }
  } else {
    document.getElementById('activeRowInfo').style.display = 'none';
    currentActiveRow = -1;
  }
}

// ============ MODAL GPS ============
function showGPSCoordModal() {
  if (!currentGPS.fix || currentGPS.lon === 0 || currentGPS.lat === 0) {
    showNotify('Data GPS belum tersedia!', false);
    return;
  }
  
  const modal = document.getElementById('gpsModal');
  const coordDisplay = document.getElementById('modalCurrentCoord');
  const statusDisplay = document.getElementById('modalGPSStatus');
  
  coordDisplay.textContent = 'Lon: ' + currentGPS.lon.toFixed(6) + ', Lat: ' + currentGPS.lat.toFixed(6);
  statusDisplay.innerHTML = 'âœ… GPS aktif - ' + new Date().toLocaleTimeString();
  
  if (currentActiveRow >= 0) {
    document.getElementById('activeRowInfo').style.display = 'block';
    document.getElementById('activeRowNumber').textContent = 
      'Baris #' + (currentActiveRow + 1) + ' - ' + (rambuData[currentActiveRow]?.area || 'No Area');
  } else {
    document.getElementById('activeRowInfo').style.display = 'none';
  }
  
  modal.style.display = 'block';
}

function closeGPSCoordModal() {
  document.getElementById('gpsModal').style.display = 'none';
}

function applyGPSCoordinates() {
  if (!currentGPS.fix) {
    showNotify('Data GPS tidak valid!', false);
    return;
  }
  
  const fillType = document.querySelector('input[name="fillType"]:checked').value;
  const formattedLon = currentGPS.lon.toFixed(6);
  const formattedLat = currentGPS.lat.toFixed(6);
  let filledCount = 0;
  
  if (fillType === 'activeRow') {
    if (currentActiveRow === -1) {
      showNotify('Tidak ada baris yang aktif! Klik dulu pada salah satu baris di tabel.', false);
      return;
    }
    
    const rows = document.querySelectorAll('#tableBody tr');
    if (currentActiveRow >= rows.length) {
      showNotify('Baris aktif tidak valid!', false);
      return;
    }
    
    const activeRow = rows[currentActiveRow];
    const lonInput = activeRow.querySelector('.lon-input');
    const latInput = activeRow.querySelector('.lat-input');
    
    if (lonInput && latInput) {
      lonInput.value = formattedLon;
      latInput.value = formattedLat;
      filledCount = 2;
      
      const saveBtn = activeRow.querySelector('.btn-save');
      if (saveBtn) {
        saveBtn.click();
      }
    }
  } else if (fillType === 'both') {
    document.querySelectorAll('.lon-input').forEach(input => {
      if (!input.value || input.value === '0.000000') {
        input.value = formattedLon;
        filledCount++;
      }
    });
    document.querySelectorAll('.lat-input').forEach(input => {
      if (!input.value || input.value === '0.000000') {
        input.value = formattedLat;
        filledCount++;
      }
    });
  }
  
  closeGPSCoordModal();
  showNotify('Berhasil mengisi ' + filledCount + ' koordinat dengan GPS saat ini');
}

window.onclick = function(event) {
  const modal = document.getElementById('gpsModal');
  if (event.target === modal) {
    closeGPSCoordModal();
  }
}

// ============ FUNGSI LOAD DATA ============
async function loadData(){  
  try{ 
    const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`);
    const data = await response.json();
    rambuData = data.rambu || [];
    
    // Set GPS from first rambu or default
    if (rambuData.length > 0) {
      setCurrentGPS(rambuData[0].lon, rambuData[0].lat, true);
    }
    
    renderTable(); 
    addLog('Data rambu loaded: ' + rambuData.length + ' entries');
  } catch(e) {
    console.error(e);
    addLog('Error loading data: ' + e.message);
    showNotify('Failed to load data', false);
  } 
}  

// ============ FUNGSI FILTER TABLE ============
function filterTable() {
  const filterValue = document.getElementById('filterJalur').value;
  const rows = document.querySelectorAll('#tableBody tr');
  
  rows.forEach(row => {
    const jalurSelect = row.cells[6].querySelector('select');
    const jalurValue = jalurSelect ? jalurSelect.value : '0';
    
    if (filterValue === 'all' || jalurValue === filterValue) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ============ FUNGSI RENDER TABLE ============
function renderTable(){  
  const body = document.getElementById('tableBody'); 
  body.innerHTML = '';  
  rambuData.forEach((r,i)=>{ 
    const tr = document.createElement('tr');  
    tr.onclick = () => setActiveRow(i);
    
    const jalurClass = r.jalur === 0 ? 'jalur-muatan' : r.jalur === 1 ? 'jalur-kosongan' : 'jalur-luar';
    tr.className = jalurClass;
    
    const inp=(v,t='text')=>{
      const x=document.createElement('input');
      x.value=v;
      x.type=t;
      return x;
    };
    
    const coordInp=(v,className)=>{
      const x=document.createElement('input');
      x.value=v;
      x.type='text';
      x.className=className;
      return x;
    };
    
    const sel=(options, selected)=>{
      const s=document.createElement('select'); 
      options.forEach(opt=>{  
        const o=document.createElement('option'); 
        o.value=opt.value; 
        o.textContent=opt.text;  
        if(opt.value==selected) o.selected=true; 
        s.appendChild(o); 
      }); 
      return s; 
    };  
    
    const chk=(checked)=>{
      const c=document.createElement('input'); 
      c.type='checkbox'; 
      c.checked=checked; 
      return c; 
    };  
    
    const tdNo=document.createElement('td');
    tdNo.textContent=i+1;
    tr.appendChild(tdNo);
    
    const tdLon=document.createElement('td');
    const inLon=coordInp(r.lon.toFixed(6),'lon-input longlat-input');
    inLon.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    tdLon.appendChild(inLon);
    tr.appendChild(tdLon);
    
    const tdLat=document.createElement('td');
    const inLat=coordInp(r.lat.toFixed(6),'lat-input longlat-input');
    inLat.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    tdLat.appendChild(inLat);
    tr.appendChild(tdLat);
    
    const inArea=inp(r.nama);
    inArea.className='area-input';
    inArea.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inLimit=inp(r.limit,'number'); 
    inLimit.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inRad=inp(r.radius,'number');
    inRad.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inCheckpoint=inp(r.checkpoint,'number');
    inCheckpoint.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const selJalur=sel([
      {value:0,text:'Muatan'}, 
      {value:1,text:'Kosongan'}, 
      {value:2,text:'Luar Area'}
    ], r.jalur);  
    
    selJalur.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const trackOptions = Array.from({length:50},(_,i)=>({ 
      value: i+1, 
      text: (i+1) + ' - Track ' + (i+1) 
    }));  
    
    const selMp3=sel(trackOptions, r.mp3Track || 1); 
    selMp3.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const chkOneTime=chk(r.oneTimeMP3 || false); 
    chkOneTime.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const chkEnabled=chk(r.enabled);
    chkEnabled.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const saveBtn=document.createElement('button'); 
    saveBtn.className='btn-save'; 
    saveBtn.textContent='Save';  
    saveBtn.onclick=async(e)=>{ 
      e.stopPropagation();
      const row={ 
        lon:parseFloat(inLon.value)||0, 
        lat:parseFloat(inLat.value)||0,  
        nama:inArea.value||'',  
        limit:parseInt(inLimit.value)||0, 
        radius:parseInt(inRad.value)||0, 
        jalur:parseInt(selJalur.value)||0, 
        enabled:chkEnabled.checked,  
        mp3Track:parseInt(selMp3.value)||1, 
        checkpoint:parseInt(inCheckpoint.value)||(i+1), 
        oneTimeMP3:chkOneTime.checked 
      };  
      
      await saveRambuToGitHub(i, row);
      rambuData = await loadRambuFromGitHub();
      renderTable(); 
      showNotify('Rambu saved');
      addLog('Saved rambu: ' + row.nama);
    };  
    
    const delBtn=document.createElement('button'); 
    delBtn.className='btn-delete'; 
    delBtn.textContent='Delete';  
    delBtn.onclick=async(e)=>{ 
      e.stopPropagation();
      if(confirm('Delete this rambu?')){ 
        await deleteRambuFromGitHub(i);
        rambuData = await loadRambuFromGitHub();
        renderTable(); 
        showNotify('Rambu deleted'); 
        addLog('Deleted rambu: ' + r.nama);
      } 
    };  
    
    const tdActions=document.createElement('td'); 
    tdActions.onclick = (e) => e.stopPropagation();
    tdActions.appendChild(saveBtn); 
    tdActions.appendChild(delBtn);  
    
    const cells = [
      inArea, inLimit, inRad, selJalur, selMp3, inCheckpoint, chkOneTime, chkEnabled, tdActions
    ];
    
    cells.forEach(el=>{  
      const td=document.createElement('td');
      td.appendChild(el);
      tr.appendChild(td); 
    }); 
    
    body.appendChild(tr); 
  }); 
      
  if (rambuData.length > 0 && currentActiveRow === -1) {
    setActiveRow(0);
  }
  filterTable();
}  

// ============ FUNGSI GITHUB API ============
async function loadRambuFromGitHub() {
  try {
    const response = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`
    );
    const data = await response.json();
    return data.rambu || [];
  } catch (error) {
    console.error('Error loading from GitHub:', error);
    return [];
  }
}

async function getFileSHA() {
  try {
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    const data = await response.json();
    return data.sha;
  } catch (error) {
    console.error('Error getting SHA:', error);
    return null;
  }
}

async function saveRambuToGitHub(index, rambu) {
  try {
    // Update local data
    if (index === -1) {
      rambuData.push(rambu);
    } else {
      rambuData[index] = rambu;
    }
    
    // Get current SHA
    const sha = await getFileSHA();
    if (!sha) {
      throw new Error('Failed to get file SHA');
    }
    
    // Prepare data for GitHub
    const githubData = {
      rambu: rambuData,
      last_updated: new Date().toISOString(),
      total_count: rambuData.length
    };
    
    const content = btoa(JSON.stringify(githubData, null, 2));
    
    // Update on GitHub
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Update rambu ${index === -1 ? 'added' : 'modified'}: ${rambu.nama}`,
          content: content,
          sha: sha
        })
      }
    );
    
    if (!response.ok) {
      throw new Error('GitHub API error');
    }
    
    // Update version
    await updateVersion();
    
    return true;
  } catch (error) {
    console.error('Error saving to GitHub:', error);
    showNotify('Failed to save to GitHub', false);
    return false;
  }
}

async function deleteRambuFromGitHub(index) {
  try {
    // Remove from local data
    rambuData.splice(index, 1);
    
    // Get current SHA
    const sha = await getFileSHA();
    if (!sha) {
      throw new Error('Failed to get file SHA');
    }
    
    // Prepare data for GitHub
    const githubData = {
      rambu: rambuData,
      last_updated: new Date().toISOString(),
      total_count: rambuData.length
    };
    
    const content = btoa(JSON.stringify(githubData, null, 2));
    
    // Update on GitHub
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Delete rambu at index ${index}`,
          content: content,
          sha: sha
        })
      }
    );
    
    if (!response.ok) {
      throw new Error('GitHub API error');
    }
    
    // Update version
    await updateVersion();
    
    return true;
  } catch (error) {
    console.error('Error deleting from GitHub:', error);
    showNotify('Failed to delete from GitHub', false);
    return false;
  }
}

async function updateVersion() {
  try {
    // Get current version
    const versionResponse = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    let currentVersion = 1;
    
    if (versionResponse.ok) {
      const versionText = await versionResponse.text();
      currentVersion = parseInt(versionText.trim()) || 1;
    }
    
    const newVersion = currentVersion + 1;
    
    // Get SHA of version file
    const shaResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    const shaData = await shaResponse.json();
    const sha = shaData.sha;
    
    // Update version file
    await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Update to version ${newVersion}`,
          content: btoa(String(newVersion)),
          sha: sha
        })
      }
    );
    
    addLog(`Version updated to ${newVersion}`);
  } catch (error) {
    console.error('Error updating version:', error);
  }
}

// ============ FUNGSI ADD ROW ============
function addRow(){ 
  const newIndex = rambuData.length;
  const newRow = {
    lon: currentGPS.lon || 117.49389,
    lat: currentGPS.lat || -2.153491,
    nama: 'New Area ' + (newIndex + 1),
    limit: 30,
    radius: 100,
    jalur: 0,
    enabled: true,
    mp3Track: 1,
    checkpoint: newIndex + 1,
    oneTimeMP3: false
  };
  
  rambuData.push(newRow);
  renderTable();
  setActiveRow(newIndex);
  showNotify('New row added');
  addLog('Added new row');
}  

// ============ FUNGSI EXPORT CSV ============
function exportCSV(){  
  let csv = 'longitude,latitude,area,limit_kph,radius_m,jalur,mp3_track,checkpoint,one_time_mp3,enabled\n';
  
  rambuData.forEach(rambu => {
    csv += `${rambu.lon},${rambu.lat},${rambu.nama},${rambu.limit},${rambu.radius},`;
    csv += `${rambu.jalur},${rambu.mp3Track || 1},${rambu.checkpoint},`;
    csv += `${rambu.oneTimeMP3 ? '1' : '0'},${rambu.enabled ? '1' : '0'}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rambu_data_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotify('CSV Exported');
  addLog('Exported CSV file');
}  

// ============ FUNGSI IMPORT CSV ============
async function importCSV(input){  
  const file = input.files[0];  
  if(!file) return;  
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const csvText = e.target.result;
    
    try {
      const lines = csvText.split('\n');
      const newRambuData = [];
      
      // Skip header
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const fields = line.split(',');
        if (fields.length >= 6) {
          const rambu = {
            lon: parseFloat(fields[0]) || 0,
            lat: parseFloat(fields[1]) || 0,
            nama: fields[2] || 'Unknown',
            limit: parseInt(fields[3]) || 30,
            radius: parseInt(fields[4]) || 100,
            jalur: parseInt(fields[5]) || 0,
            mp3Track: fields.length > 6 ? parseInt(fields[6]) || 1 : 1,
            checkpoint: fields.length > 7 ? parseInt(fields[7]) || 1 : 1,
            oneTimeMP3: fields.length > 8 ? (fields[8] === '1' || fields[8].toLowerCase() === 'true') : false,
            enabled: fields.length > 9 ? (fields[9] === '1' || fields[9].toLowerCase() === 'true') : true
          };
          newRambuData.push(rambu);
        }
      }
      
      if (newRambuData.length > 0) {
        rambuData = newRambuData;
        
        // Save to GitHub
        const sha = await getFileSHA();
        const githubData = {
          rambu: rambuData,
          last_updated: new Date().toISOString(),
          total_count: rambuData.length
        };
        
        const content = btoa(JSON.stringify(githubData, null, 2));
        
        await fetch(
          `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${GITHUB_TOKEN}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Import CSV: ${newRambuData.length} rambu`,
              content: content,
              sha: sha
            })
          }
        );
        
        await updateVersion();
        renderTable();
        showNotify(`Imported ${newRambuData.length} rambu from CSV`);
        addLog(`Imported ${newRambuData.length} rambu from CSV`);
      }
    } catch (error) {
      console.error('Import error:', error);
      showNotify('Import failed', false);
      addLog('Import failed: ' + error.message);
    }
  };
  
  reader.readAsText(file);
  input.value = '';
}  

// ============ FUNGSI SYSTEM LOG ============
function addLog(message) {
  const timestamp = new Date().toLocaleTimeString();
  systemLog.push(`[${timestamp}] ${message}`);
  
  // Keep only last 10 messages
  if (systemLog.length > 10) {
    systemLog.shift();
  }
  
  updateSerialDisplay();
}

function updateSerialDisplay() {
  const serialDiv = document.getElementById('serial');
  serialDiv.textContent = systemLog.join('\n');
  serialDiv.scrollTop = serialDiv.scrollHeight;
}

function clearSerial() {
  systemLog = ['msg:Log cleared'];
  updateSerialDisplay();
  addLog('System log cleared');
}

// ============ INISIALISASI ============
document.addEventListener('DOMContentLoaded', function() {
  // Load initial data
  loadData();
  
  // Set GPS from current location (simulated)
  setCurrentGPS(117.49389, -2.153491, true);
  
  // Initialize log
  updateSerialDisplay();
  
  // Auto-update log display
  logInterval = setInterval(updateSerialDisplay, 1000);
  
  // Add initial logs
  addLog('System initialized');
  addLog('GitHub Pages ready');
  addLog('Waiting for user input');
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  if (logInterval) {
    clearInterval(logInterval);
  }
});
</script>  
</body></html>
