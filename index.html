<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SPEEDING ALERT - Complete System</title>  
  <style>  
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0c0d10;
      color: #eee;
      margin: 14px;
      font-size: 14px;
    }
    
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #3b82f6;
    }
    
    h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #ddd;
    }
    
    /* ============ NAVIGATION TABS ============ */
    .tab-container {
      display: flex;
      gap: 2px;
      margin-bottom: 16px;
      border-bottom: 1px solid #2a2d35;
    }
    
    .tab-button {
      background: #1a1d24;
      color: #ccc;
      border: none;
      border-radius: 6px 6px 0 0;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .tab-button:hover {
      background: #2a2d35;
    }
    
    .tab-button.active {
      background: #15161a;
      color: white;
      border-bottom: 2px solid #3b82f6;
    }
    
    /* ============ CARD STYLES ============ */
    .card {
      background: #15161a;
      border: 1px solid #2a2d35;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #2a2d35;
    }
    
    /* ============ BUTTON STYLES ============ */
    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    
    .btn:hover {
      background: #2563eb;
    }
    
    .btn-success {
      background: #22c55e;
    }
    
    .btn-success:hover {
      background: #16a34a;
    }
    
    .btn-danger {
      background: #ef4444;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-warning {
      background: #f59e0b;
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
    
    /* ============ TABLE STYLES ============ */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #2a2d35;
      border-radius: 6px;
      margin-top: 12px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    th, td {
      border: 1px solid #2a2d35;
      padding: 6px;
      text-align: left;
    }
    
    thead th {
      position: sticky;
      top: 0;
      background: #15161a;
      z-index: 10;
      border-bottom: 2px solid #2a2d35;
      font-weight: 600;
    }
    
    tbody tr:hover {
      background: #1a1d24;
    }
    
    /* ============ STATUS BADGES ============ */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-align: center;
      min-width: 70px;
    }
    
    .status-online {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid #22c55e;
    }
    
    .status-offline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid #ef4444;
    }
    
    .status-waiting {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid #f59e0b;
    }
    
    /* ============ FORM STYLES ============ */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }
    
    .form-label {
      font-size: 12px;
      color: #aaa;
    }
    
    .form-input, .form-select {
      background: #0f1115;
      border: 1px solid #2a2d35;
      color: #eee;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 13px;
      width: 100%;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    /* ============ DEVICE FORM ============ */
    .device-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    /* ============ CONFIG SECTION ============ */
    .config-section {
      background: #1a1d24;
      border: 1px solid #2a2d35;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .config-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #3b82f6;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .config-help {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    
    /* ============ CONTENT AREA ============ */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ============ RAMBU TABLE SPECIFIC ============ */
    .filter-container {
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-label {
      font-size: 12px;
    }
    
    .jalur-muatan {
      border-left: 4px solid #888 !important;
    }
    
    .jalur-kosongan {
      border-left: 4px solid #3b82f6 !important;
    }
    
    .jalur-luar {
      border-left: 4px solid #ef4444 !important;
    }
    
    .active-row {
      background-color: #2a3b4c !important;
    }
    
    .k {
      display: flex;
      gap: 4.8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 4.8px;
    }
    
    .longlat-input {
      flex: 1;
      min-width: 80px;
    }
    
    .area-input {
      width: 180px;
    }
    
    /* ============ NOTIFICATION ============ */
    .notify {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: #22c55e;
      color: white;
      border-radius: 6px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .notify.error {
      background: #ef4444;
    }
    
    /* ============ MISC ============ */
    .last-seen {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }
    
    .device-list-empty {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    
    /* ============ CONFIG LOADER ============ */
    .config-loader {
      padding: 20px;
      text-align: center;
      color: #666;
    }
  </style>
</head>

<body>  
  <!-- TABS NAVIGATION -->
  <div class="tab-container">
    <button class="tab-button active" onclick="showTab('data-tab')">üìä Data Rambu</button>
    <button class="tab-button" onclick="showTab('device-tab')">üì° Device Monitor</button>
  </div>
  
  <!-- DATA RAMBU TAB -->
  <div id="data-tab" class="tab-content active">
    <h2>üìä RAMBU DATA MANAGEMENT</h2>  
      
    <div class="card">  
      <div class="k">  
        <button onclick="exportCSV()" class="btn">Export CSV</button>  
        <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(this)">  
        <button onclick="document.getElementById('importFile').click()" class="btn">Import CSV</button>  
        <button class="btn-success" onclick="addRow()">+ Add Row</button>
        <button class="btn-warning" onclick="calculateAutoRadius()">Auto Distance CP</button>
        <button class="btn-success" onclick="saveAll()">Save All</button>
      </div>  
      
      <div class="filter-container">
        <span class="filter-label">Filter Jalur:</span>
        <select id="filterJalur" onchange="filterTable()" class="form-select">
          <option value="all">Semua Jalur</option>
          <option value="0">Muatan</option>
          <option value="1">Kosongan</option>
          <option value="2">Luar Area</option>
        </select>
      </div>
      
      <div class="table-container">
        <table>  
          <thead><tr>  
            <th>#</th><th>Longitude</th><th>Latitude</th><th>Nama Area</th>  
            <th>Speed Limit</th><th>Radius</th><th>Jalur</th><th>MP3 Track</th><th>Checkpoint</th><th>1xmp3</th><th>Enabled</th><th>Actions</th>  
          </tr></thead>  
          <tbody id="tableBody"></tbody>  
        </table>  
      </div>
    </div>  
  </div>
  
  <!-- DEVICE MONITOR TAB -->
  <div id="device-tab" class="tab-content">
    <h2>üì° DEVICE MONITORING</h2>
    
    <!-- CONFIG LOADER (Tersembunyi) -->
    <div id="config-loader" class="config-loader" style="display:none">
      Loading GitHub configuration...
    </div>
    
    <!-- ADD DEVICE FORM -->
    <div class="card">
      <div class="card-header">
        <h3 style="margin:0">‚ûï Add New Device</h3>
      </div>
      
      <div class="device-form">
        <div class="form-group">
          <label class="form-label">Device ID</label>
          <select id="deviceIdSelect" class="form-select">
            <option value="">Select Device ID</option>
            <option value="SPD-ALRT001">SPD-ALRT001</option>
            <option value="SPD-ALRT002">SPD-ALRT002</option>
            <option value="SPD-ALRT003">SPD-ALRT003</option>
            <option value="SPD-ALRT004">SPD-ALRT004</option>
            <option value="SPD-ALRT005">SPD-ALRT005</option>
            <option value="SPD-ALRT006">SPD-ALRT006</option>
            <option value="SPD-ALRT007">SPD-ALRT007</option>
            <option value="SPD-ALRT008">SPD-ALRT008</option>
            <option value="SPD-ALRT009">SPD-ALRT009</option>
            <option value="SPD-ALRT010">SPD-ALRT010</option>
          </select>
        </div>
        
        <div class="form-group" style="align-self: flex-end;">
          <button onclick="addDevice()" class="btn btn-success">‚ûï Add Device</button>
        </div>
      </div>
      
      <div style="font-size:11px;color:#666;margin-top:8px">
        <strong>Note:</strong> Device must be registered here before ESP32 can send status.
      </div>
    </div>
    
    <!-- DEVICE TABLE -->
    <div class="card">
      <div class="card-header">
        <h3 style="margin:0">üìã Registered Devices</h3>
        <div>
          <button onclick="refreshAllDevices()" class="btn">üîÑ Refresh All</button>
          <button onclick="checkAllDevicesUpdate()" class="btn">üì° Check Updates</button>
          <button onclick="clearAllDevices()" class="btn btn-danger">üóëÔ∏è Clear All</button>
        </div>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th width="25%">Device</th>
              <th width="20%">Status</th>
              <th width="20%">Connection</th>
              <th width="25%">Last Updated</th>
              <th width="10%">Actions</th>
            </tr>
          </thead>
          <tbody id="deviceTableBody">
            <!-- Devices will appear here -->
          </tbody>
        </table>
      </div>
      
      <div id="emptyMessage" class="device-list-empty" style="display:none">
        No devices registered. Add devices using the form above.
      </div>
    </div>
  </div>
  
  <!-- NOTIFICATION -->
  <div id="notify" class="notify"></div>

  <script>
// ============ KONFIGURASI GLOBAL ============
let GITHUB_USER = 'cvr-gpiodev';
let GITHUB_REPO = 'rambu-speeding';
let GITHUB_TOKEN = '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';
const GITHUB_API = 'https://api.github.com';

// ============ VARIABLES ============
let rambuData = [];
let currentActiveRow = -1;
let registeredDevices = [];

// ============ TIMEOUT CONFIG ============
const CONNECTION_TIMEOUT = 30000; // 30 detik

// ============ TAB FUNCTIONS ============
function showTab(tabId) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(tabId).classList.add('active');
  
  // Update tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  event.target.classList.add('active');
  
  // Refresh data if needed
  if (tabId === 'data-tab') {
    updateDeviceStatusOnRambuTab();
  }
}

// ============ GITHUB CONFIGURATION ============
function loadConfig() {
  const config = localStorage.getItem('github_config');
  if (config) {
    const { user, repo, token } = JSON.parse(config);
    GITHUB_USER = user || 'fahruldev';
    GITHUB_REPO = repo || 'rambu-database';
    GITHUB_TOKEN = token || '';
  }
}

function saveGitHubConfig(user, repo, token) {
  GITHUB_USER = user || GITHUB_USER;
  GITHUB_REPO = repo || GITHUB_REPO;
  GITHUB_TOKEN = token || GITHUB_TOKEN;
  
  const config = { user: GITHUB_USER, repo: GITHUB_REPO, token: GITHUB_TOKEN };
  localStorage.setItem('github_config', JSON.stringify(config));
  console.log('GitHub configuration saved');
}

// ============ DEVICE MONITORING FUNCTIONS ============
function loadDevices() {
  const saved = localStorage.getItem('registered_devices');
  if (saved) {
    registeredDevices = JSON.parse(saved);
    // Validasi ulang device yang ada
    registeredDevices.forEach(device => {
      device.lastSeen = validateDeviceTimestamp(device.lastSeen);
      device.lastUpdate = validateDeviceTimestamp(device.lastUpdate);
    });
  }
  updateDeviceTable();
}

function saveDevices() {
  localStorage.setItem('registered_devices', JSON.stringify(registeredDevices));
}

function validateDeviceTimestamp(timestamp) {
  if (!timestamp) return null;
  
  const date = new Date(timestamp);
  if (isNaN(date.getTime())) {
    return null;
  }
  return timestamp;
}

function isValidDeviceId(deviceId) {
  // Validasi format device ID: SPD-ALRTXXX
  const pattern = /^SPD-ALRT\d{3}$/;
  return pattern.test(deviceId);
}

function addDevice() {
  const deviceId = document.getElementById('deviceIdSelect').value;
  
  if (!deviceId) {
    showNotify('Please select a Device ID', false);
    return;
  }
  
  // Validasi device ID
  if (!isValidDeviceId(deviceId)) {
    showNotify('Invalid Device ID format. Must be SPD-ALRTXXX', false);
    return;
  }
  
  // Check if device already exists
  if (registeredDevices.some(device => device.id === deviceId)) {
    showNotify(`Device ${deviceId} already exists`, false);
    return;
  }
  
  // Add new device
  const newDevice = {
    id: deviceId,
    status: 'waiting',
    connection: 'offline',
    lastSeen: null,
    lastUpdate: null,
    dataVersion: 0,
    added: new Date().toISOString(),
    verified: true
  };
  
  registeredDevices.push(newDevice);
  saveDevices();
  
  // Clear form
  document.getElementById('deviceIdSelect').value = '';
  
  showNotify(`Device ${deviceId} registered successfully`);
  updateDeviceTable();
}

async function updateDeviceStatus(deviceId, statusData) {
  // Validasi device ID terlebih dahulu
  if (!isValidDeviceId(deviceId)) {
    console.error(`Invalid device ID: ${deviceId}`);
    return false;
  }
  
  // Cari device dengan validasi yang ketat
  const deviceIndex = registeredDevices.findIndex(d => d.id === deviceId && d.verified === true);
  if (deviceIndex === -1) {
    console.error(`Device ${deviceId} not registered or not verified`);
    return false;
  }
  
  // Update status
  const now = new Date();
  const device = registeredDevices[deviceIndex];
  
  // Verifikasi timestamp
  const receivedTime = statusData.timestamp ? new Date(statusData.timestamp) : now;
  if (isNaN(receivedTime.getTime())) {
    console.error(`Invalid timestamp for device ${deviceId}`);
    return false;
  }
  
  // Update connection status
  device.connection = 'online';
  device.lastSeen = receivedTime.toISOString();
  
  // Update device status
  if (statusData.status_type === 'data_updated') {
    device.status = 'updated';
    device.lastUpdate = receivedTime.toISOString();
    
    // Update version in GitHub
    const newVersion = await updateVersionOnGitHub(deviceId);
    if (newVersion) {
      device.dataVersion = newVersion;
      device.message = `Updated to v${newVersion}`;
    }
    
  } else if (statusData.status_type === 'online') {
    device.status = 'online';
    device.lastUpdate = receivedTime.toISOString();
    device.message = statusData.message || 'Device online';
  } else {
    device.message = statusData.message || 'Status update';
  }
  
  saveDevices();
  updateDeviceTable();
  
  console.log(`Status updated for ${deviceId}`);
  return true;
}

function checkConnectionTimeout(device) {
  if (!device.lastSeen) return true;
  
  const lastSeen = new Date(device.lastSeen);
  const now = new Date();
  const timeDiff = now - lastSeen;
  
  return timeDiff > CONNECTION_TIMEOUT;
}

async function updateVersionOnGitHub(deviceId) {
  if (!GITHUB_USER || !GITHUB_REPO || !GITHUB_TOKEN) {
    console.log('GitHub configuration missing');
    return null;
  }
  
  try {
    // Get current version
    const versionResponse = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    
    let currentVersion = 1;
    if (versionResponse.ok) {
      const versionText = await versionResponse.text();
      currentVersion = parseInt(versionText.trim()) || 1;
    }
    
    const newVersion = currentVersion + 1;
    
    // Get SHA of version file
    const shaResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    if (!shaResponse.ok) {
      throw new Error('Failed to get file SHA');
    }
    
    const shaData = await shaResponse.json();
    const sha = shaData.sha;
    
    // Update version file
    const updateResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Device ${deviceId} updated data - v${newVersion}`,
          content: btoa(String(newVersion)),
          sha: sha
        })
      }
    );
    
    if (!updateResponse.ok) {
      throw new Error('Failed to update version');
    }
    
    console.log(`‚úÖ Version updated to ${newVersion} for ${deviceId}`);
    return newVersion;
    
  } catch (error) {
    console.error('‚ùå Error updating version:', error);
    return null;
  }
}

function updateDeviceTable() {
  const tbody = document.getElementById('deviceTableBody');
  const emptyMsg = document.getElementById('emptyMessage');
  
  if (registeredDevices.length === 0) {
    tbody.innerHTML = '';
    emptyMsg.style.display = 'block';
    return;
  }
  
  emptyMsg.style.display = 'none';
  
  let html = '';
  const now = new Date();
  
  registeredDevices.forEach(device => {
    const lastSeen = device.lastSeen ? new Date(device.lastSeen) : null;
    const lastUpdate = device.lastUpdate ? new Date(device.lastUpdate) : null;
    
    // Check connection timeout (30 detik)
    const isTimeout = checkConnectionTimeout(device);
    
    // Determine connection badge
    let connectionBadge = 'status-offline';
    let connectionText = 'Offline';
    
    if (lastSeen && !isTimeout) {
      const secondsAgo = Math.floor((now - lastSeen) / 1000);
      
      if (secondsAgo < 30) {
        connectionBadge = 'status-online';
        connectionText = 'Online';
      } else {
        connectionBadge = 'status-offline';
        connectionText = 'Offline';
      }
    }
    
    // Determine status badge
    let statusBadge = 'status-waiting';
    let statusText = 'Waiting';
    let lastUpdateText = 'Never';
    
    if (lastUpdate) {
      const updateMinutesAgo = Math.floor((now - lastUpdate) / 60000);
      
      if (updateMinutesAgo < 5) {
        statusBadge = 'status-online';
        statusText = 'Updated';
      } else if (updateMinutesAgo < 10) {
        statusBadge = 'status-waiting';
        statusText = 'Pending';
      } else {
        statusBadge = 'status-offline';
        statusText = 'Stale';
      }
      lastUpdateText = `${updateMinutesAgo} min ago`;
    }
    
    // Add data version info
    const versionInfo = device.dataVersion > 0 ? `v${device.dataVersion}` : 'No data';
    
    // Add verification badge
    const verifiedBadge = device.verified ? '‚úÖ' : '‚ö†Ô∏è';
    
    html += `
      <tr>
        <td>
          <strong>${device.id}</strong><br>
          <small style="color:#666;font-size:10px">${versionInfo} ${verifiedBadge}</small>
        </td>
        <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
        <td><span class="status-badge ${connectionBadge}">${connectionText}</span></td>
        <td>
          ${lastUpdateText}<br>
          <small class="last-seen">Last seen: ${lastSeen ? Math.floor((now - lastSeen)/1000) + ' sec ago' : 'Never'}</small>
          ${device.message ? `<br><small style="color:#3b82f6;font-size:10px">${device.message}</small>` : ''}
          ${isTimeout ? `<br><small style="color:#ef4444;font-size:10px">Connection timeout</small>` : ''}
        </td>
        <td>
          <button onclick="testDevice('${device.id}')" class="btn" style="padding:4px 8px;font-size:11px;margin-bottom:2px">Test</button>
          <button onclick="checkDeviceUpdate('${device.id}')" class="btn" style="padding:4px 8px;font-size:11px">Check Update</button>
          <button onclick="removeDevice('${device.id}')" class="btn btn-danger" style="padding:4px 8px;font-size:11px;margin-top:2px">Remove</button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

async function checkDeviceUpdate(deviceId) {
  if (!GITHUB_USER || !GITHUB_REPO) {
    showNotify('GitHub configuration required', false);
    return;
  }
  
  try {
    const response = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    
    if (response.ok) {
      const versionText = await response.text();
      const currentVersion = parseInt(versionText.trim()) || 1;
      
      const deviceIndex = registeredDevices.findIndex(d => d.id === deviceId);
      if (deviceIndex !== -1) {
        const device = registeredDevices[deviceIndex];
        
        if (currentVersion > device.dataVersion) {
          device.dataVersion = currentVersion;
          device.status = 'updated';
          device.lastUpdate = new Date().toISOString();
          device.message = `Data v${currentVersion} available`;
          
          saveDevices();
          updateDeviceTable();
          
          showNotify(`Device ${deviceId} has new data v${currentVersion}`);
        } else {
          showNotify(`Device ${deviceId} is up to date (v${currentVersion})`);
        }
      }
    }
  } catch (error) {
    showNotify(`Failed to check updates: ${error.message}`, false);
  }
}

function checkAllDevicesUpdate() {
  registeredDevices.forEach(device => {
    checkDeviceUpdate(device.id);
  });
}

function removeDevice(deviceId) {
  if (confirm(`Remove device ${deviceId} from monitoring?`)) {
    registeredDevices = registeredDevices.filter(d => d.id !== deviceId);
    saveDevices();
    updateDeviceTable();
    showNotify(`Device ${deviceId} removed`);
  }
}

function testDevice(deviceId) {
  // Simulate test connection
  const mockData = {
    device_id: deviceId,
    status_type: 'heartbeat',
    message: 'Test connection',
    timestamp: new Date().toISOString()
  };
  
  if (updateDeviceStatus(deviceId, mockData)) {
    showNotify(`Test connection sent to ${deviceId}`);
  }
}

function refreshAllDevices() {
  // Check for connection timeout
  const now = new Date();
  let updatedCount = 0;
  
  registeredDevices.forEach(device => {
    if (device.lastSeen) {
      const timeDiff = now - new Date(device.lastSeen);
      
      if (timeDiff > CONNECTION_TIMEOUT) {
        device.connection = 'offline';
        device.message = 'Connection timeout (30s)';
        updatedCount++;
      }
    }
  });
  
  saveDevices();
  updateDeviceTable();
  showNotify(`Refreshed ${updatedCount} devices`);
}

function clearAllDevices() {
  if (confirm('Clear all registered devices? This cannot be undone.')) {
    registeredDevices = [];
    saveDevices();
    updateDeviceTable();
    showNotify('All devices cleared');
  }
}

function setupDeviceWebhookListener() {
  // Check connection timeout setiap 10 detik
  setInterval(() => {
    refreshAllDevices();
  }, 10000);
}

// ============ RAMBU DATA FUNCTIONS ============
async function loadData(){  
  try{ 
    if (!GITHUB_USER || !GITHUB_REPO) {
      console.log('GitHub config not set');
      return;
    }
    
    const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`);
    const data = await response.json();
    rambuData = data.rambu || [];
    renderTable(); 
  } catch(e) {
    console.error(e);
  } 
}

function updateDeviceStatusOnRambuTab() {
  // Update device status in rambu tab if needed
  const onlineDevices = registeredDevices.filter(d => d.connection === 'online').length;
  const totalDevices = registeredDevices.length;
  
  if (totalDevices > 0) {
    console.log(`Devices: ${onlineDevices}/${totalDevices} online`);
  }
}

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function calculateAutoRadius() {
  const rows = document.querySelectorAll('#tableBody tr');
  const rambuByJalur = {0: [], 1: []};
  
  rows.forEach((row, index) => {
    const jalurSelect = row.cells[6].querySelector('select');
    const jalur = parseInt(jalurSelect.value);
    
    if (jalur === 0 || jalur === 1) {
      const lonInput = row.cells[1].querySelector('input');
      const latInput = row.cells[2].querySelector('input');
      const checkpointInput = row.cells[8].querySelector('input');
      
      const lon = parseFloat(lonInput.value);
      const lat = parseFloat(latInput.value);
      const checkpoint = parseInt(checkpointInput.value);
      
      if (!isNaN(lon) && !isNaN(lat)) {
        rambuByJalur[jalur].push({
          rowIndex: index,
          row: row,
          lon: lon,
          lat: lat,
          checkpoint: checkpoint
        });
      }
    }
  });
  
  for (const jalur in rambuByJalur) {
    const rambus = rambuByJalur[jalur];
    
    rambus.sort((a, b) => a.checkpoint - b.checkpoint);
    
    for (let i = 0; i < rambus.length; i++) {
      let radius = 2000;
      
      if (i < rambus.length - 1) {
        const next = rambus[i + 1];
        const distance = haversineDistance(
          rambus[i].lat, rambus[i].lon,
          next.lat, next.lon
        );
        
        radius = Math.max(20, Math.min(3000, distance));
      }
      
      const radiusInput = rambus[i].row.cells[5].querySelector('input');
      radiusInput.value = Math.round(radius);
    }
  }
  
  showNotify('Radius otomatis dihitung');
}

function saveAll() {
  const rows = document.querySelectorAll('#tableBody tr');
  let savedCount = 0;
  
  rows.forEach((row, index) => {
    const saveBtn = row.querySelector('.btn-save');
    if (saveBtn) {
      saveBtn.click();
      savedCount++;
    }
  });
  
  showNotify(`${savedCount} rambu data saved.`);
}

function setActiveRow(rowIndex) {
  document.querySelectorAll('#tableBody tr').forEach(tr => {
    tr.classList.remove('active-row');
  });
  
  if (rowIndex >= 0) {
    const rows = document.querySelectorAll('#tableBody tr');
    if (rowIndex < rows.length) {
      rows[rowIndex].classList.add('active-row');
      currentActiveRow = rowIndex;
    }
  }
}

function filterTable() {
  const filterValue = document.getElementById('filterJalur').value;
  const rows = document.querySelectorAll('#tableBody tr');
  
  rows.forEach(row => {
    const jalurSelect = row.cells[6].querySelector('select');
    const jalurValue = jalurSelect ? jalurSelect.value : '0';
    
    if (filterValue === 'all' || jalurValue === filterValue) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function renderTable(){  
  const body = document.getElementById('tableBody'); 
  body.innerHTML = '';  
  rambuData.forEach((r,i)=>{ 
    const tr = document.createElement('tr');  
    tr.onclick = () => setActiveRow(i);
    
    const jalurClass = r.jalur === 0 ? 'jalur-muatan' : r.jalur === 1 ? 'jalur-kosongan' : 'jalur-luar';
    tr.className = jalurClass;
    
    const inp=(v,t='text')=>{
      const x=document.createElement('input');
      x.value=v;
      x.type=t;
      x.className = 'form-input';
      return x;
    };
    
    const coordInp=(v,className)=>{
      const x=document.createElement('input');
      x.value=v;
      x.type='text';
      x.className=`form-input ${className}`;
      return x;
    };
    
    const sel=(options, selected)=>{
      const s=document.createElement('select'); 
      s.className = 'form-select';
      options.forEach(opt=>{  
        const o=document.createElement('option'); 
        o.value=opt.value; 
        o.textContent=opt.text;  
        if(opt.value==selected) o.selected=true; 
        s.appendChild(o); 
      }); 
      return s; 
    };  
    
    const chk=(checked)=>{
      const c=document.createElement('input'); 
      c.type='checkbox'; 
      c.checked=checked; 
      c.className = 'form-input';
      return c; 
    };  
    
    const tdNo=document.createElement('td');
    tdNo.textContent=i+1;
    tr.appendChild(tdNo);
    
    const tdLon=document.createElement('td');
    const inLon=coordInp(r.lon.toFixed(6),'lon-input longlat-input');
    inLon.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    tdLon.appendChild(inLon);
    tr.appendChild(tdLon);
    
    const tdLat=document.createElement('td');
    const inLat=coordInp(r.lat.toFixed(6),'lat-input longlat-input');
    inLat.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    tdLat.appendChild(inLat);
    tr.appendChild(tdLat);
    
    const inArea=inp(r.nama);
    inArea.className='form-input area-input';
    inArea.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inLimit=inp(r.limit,'number'); 
    inLimit.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inRad=inp(r.radius,'number');
    inRad.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const inCheckpoint=inp(r.checkpoint,'number');
    inCheckpoint.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const selJalur=sel([
      {value:0,text:'Muatan'}, 
      {value:1,text:'Kosongan'}, 
      {value:2,text:'Luar Area'}
    ], r.jalur);  
    
    selJalur.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const trackOptions = Array.from({length:50},(_,i)=>({ 
      value: i+1, 
      text: (i+1) + ' - Track ' + (i+1) 
    }));  
    
    const selMp3=sel(trackOptions, r.mp3Track || 1); 
    selMp3.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const chkOneTime=chk(r.oneTimeMP3 || false); 
    chkOneTime.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const chkEnabled=chk(r.enabled);
    chkEnabled.onclick = (e) => {
      e.stopPropagation();
      setActiveRow(i);
    };
    
    const saveBtn=document.createElement('button'); 
    saveBtn.className='btn btn-success'; 
    saveBtn.textContent='Save';  
    saveBtn.onclick=async(e)=>{ 
      e.stopPropagation();
      const row={ 
        lon:parseFloat(inLon.value)||0, 
        lat:parseFloat(inLat.value)||0,  
        nama:inArea.value||'',  
        limit:parseInt(inLimit.value)||0, 
        radius:parseInt(inRad.value)||0, 
        jalur:parseInt(selJalur.value)||0, 
        enabled:chkEnabled.checked,  
        mp3Track:parseInt(selMp3.value)||1, 
        checkpoint:parseInt(inCheckpoint.value)||(i+1), 
        oneTimeMP3:chkOneTime.checked 
      };  
      
      await saveRambuToGitHub(i, row);
      rambuData = await loadRambuFromGitHub();
      renderTable(); 
      showNotify('Rambu saved');
    };  
    
    const delBtn=document.createElement('button'); 
    delBtn.className='btn btn-danger'; 
    delBtn.textContent='Delete';  
    delBtn.onclick=async(e)=>{ 
      e.stopPropagation();
      if(confirm('Delete this rambu?')){ 
        await deleteRambuFromGitHub(i);
        rambuData = await loadRambuFromGitHub();
        renderTable(); 
        showNotify('Rambu deleted'); 
      } 
    };  
    
    const tdActions=document.createElement('td'); 
    tdActions.onclick = (e) => e.stopPropagation();
    tdActions.appendChild(saveBtn); 
    tdActions.appendChild(delBtn);  
    
    const cells = [
      inArea, inLimit, inRad, selJalur, selMp3, inCheckpoint, chkOneTime, chkEnabled, tdActions
    ];
    
    cells.forEach(el=>{  
      const td=document.createElement('td');
      td.appendChild(el);
      tr.appendChild(td); 
    }); 
    
    body.appendChild(tr); 
  }); 
      
  if (rambuData.length > 0 && currentActiveRow === -1) {
    setActiveRow(0);
  }
  filterTable();
}  

async function loadRambuFromGitHub() {
  try {
    if (!GITHUB_USER || !GITHUB_REPO) {
      console.log('GitHub config not set');
      return [];
    }
    
    const response = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`
    );
    const data = await response.json();
    return data.rambu || [];
  } catch (error) {
    console.error('Error loading from GitHub:', error);
    return [];
  }
}

async function getFileSHA() {
  try {
    if (!GITHUB_USER || !GITHUB_REPO || !GITHUB_TOKEN) {
      throw new Error('GitHub configuration missing');
    }
    
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    const data = await response.json();
    return data.sha;
  } catch (error) {
    console.error('Error getting SHA:', error);
    return null;
  }
}

async function saveRambuToGitHub(index, rambu) {
  try {
    if (index === -1) {
      rambuData.push(rambu);
    } else {
      rambuData[index] = rambu;
    }
    
    const sha = await getFileSHA();
    if (!sha) {
      throw new Error('Failed to get file SHA');
    }
    
    const githubData = {
      rambu: rambuData,
      last_updated: new Date().toISOString(),
      total_count: rambuData.length
    };
    
    const content = btoa(JSON.stringify(githubData, null, 2));
    
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Update rambu ${index === -1 ? 'added' : 'modified'}: ${rambu.nama}`,
          content: content,
          sha: sha
        })
      }
    );
    
    if (!response.ok) {
      throw new Error('GitHub API error');
    }
    
    await updateRambuVersion();
    
    return true;
  } catch (error) {
    console.error('Error saving to GitHub:', error);
    showNotify('Failed to save to GitHub', false);
    return false;
  }
}

async function deleteRambuFromGitHub(index) {
  try {
    rambuData.splice(index, 1);
    
    const sha = await getFileSHA();
    if (!sha) {
      throw new Error('Failed to get file SHA');
    }
    
    const githubData = {
      rambu: rambuData,
      last_updated: new Date().toISOString(),
      total_count: rambuData.length
    };
    
    const content = btoa(JSON.stringify(githubData, null, 2));
    
    const response = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Delete rambu at index ${index}`,
          content: content,
          sha: sha
        })
      }
    );
    
    if (!response.ok) {
      throw new Error('GitHub API error');
    }
    
    await updateRambuVersion();
    
    return true;
  } catch (error) {
    console.error('Error deleting from GitHub:', error);
    showNotify('Failed to delete from GitHub', false);
    return false;
  }
}

async function updateRambuVersion() {
  try {
    if (!GITHUB_USER || !GITHUB_REPO || !GITHUB_TOKEN) {
      return;
    }
    
    const versionResponse = await fetch(
      `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`
    );
    let currentVersion = 1;
    
    if (versionResponse.ok) {
      const versionText = await versionResponse.text();
      currentVersion = parseInt(versionText.trim()) || 1;
    }
    
    const newVersion = currentVersion + 1;
    
    const shaResponse = await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    
    const shaData = await shaResponse.json();
    const sha = shaData.sha;
    
    await fetch(
      `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Update to version ${newVersion}`,
          content: btoa(String(newVersion)),
          sha: sha
        })
      }
    );
    
  } catch (error) {
    console.error('Error updating version:', error);
  }
}

function addRow(){ 
  const newIndex = rambuData.length;
  const newRow = {
    lon: 117.49389,
    lat: -2.153491,
    nama: 'New Area ' + (newIndex + 1),
    limit: 30,
    radius: 100,
    jalur: 0,
    enabled: true,
    mp3Track: 1,
    checkpoint: newIndex + 1,
    oneTimeMP3: false
  };
  
  rambuData.push(newRow);
  renderTable();
  setActiveRow(newIndex);
  showNotify('New row added');
}  

function exportCSV(){  
  let csv = 'longitude,latitude,area,limit_kph,radius_m,jalur,mp3_track,checkpoint,one_time_mp3,enabled\n';
  
  rambuData.forEach(rambu => {
    csv += `${rambu.lon},${rambu.lat},${rambu.nama},${rambu.limit},${rambu.radius},`;
    csv += `${rambu.jalur},${rambu.mp3Track || 1},${rambu.checkpoint},`;
    csv += `${rambu.oneTimeMP3 ? '1' : '0'},${rambu.enabled ? '1' : '0'}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rambu_data_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotify('CSV Exported');
}  

async function importCSV(input){  
  const file = input.files[0];  
  if(!file) return;  
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const csvText = e.target.result;
    
    try {
      const lines = csvText.split('\n');
      const newRambuData = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const fields = line.split(',');
        if (fields.length >= 6) {
          const rambu = {
            lon: parseFloat(fields[0]) || 0,
            lat: parseFloat(fields[1]) || 0,
            nama: fields[2] || 'Unknown',
            limit: parseInt(fields[3]) || 30,
            radius: parseInt(fields[4]) || 100,
            jalur: parseInt(fields[5]) || 0,
            mp3Track: fields.length > 6 ? parseInt(fields[6]) || 1 : 1,
            checkpoint: fields.length > 7 ? parseInt(fields[7]) || 1 : 1,
            oneTimeMP3: fields.length > 8 ? (fields[8] === '1' || fields[8].toLowerCase() === 'true') : false,
            enabled: fields.length > 9 ? (fields[9] === '1' || fields[9].toLowerCase() === 'true') : true
          };
          newRambuData.push(rambu);
        }
      }
      
      if (newRambuData.length > 0) {
        rambuData = newRambuData;
        
        const sha = await getFileSHA();
        const githubData = {
          rambu: rambuData,
          last_updated: new Date().toISOString(),
          total_count: rambuData.length
        };
        
        const content = btoa(JSON.stringify(githubData, null, 2));
        
        await fetch(
          `${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${GITHUB_TOKEN}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Import CSV: ${newRambuData.length} rambu`,
              content: content,
              sha: sha
            })
          }
        );
        
        await updateRambuVersion();
        renderTable();
        showNotify(`Imported ${newRambuData.length} rambu from CSV`);
      }
    } catch (error) {
      console.error('Import error:', error);
      showNotify('Import failed', false);
    }
  };
  
  reader.readAsText(file);
  input.value = '';
}  

// ============ NOTIFICATION ============
function showNotify(message, isSuccess = true) {
  const notify = document.getElementById('notify');
  notify.textContent = message;
  notify.className = isSuccess ? 'notify' : 'notify error';
  notify.style.display = 'block';
  
  setTimeout(() => {
    notify.style.display = 'none';
  }, 3000);
}

// ============ API ENDPOINT FOR ESP32 ============
window.receiveDeviceStatus = function(deviceId, statusType, message) {
  // Validasi device ID format
  if (!isValidDeviceId(deviceId)) {
    console.error(`Invalid device ID format: ${deviceId}`);
    return false;
  }
  
  // Cari device yang terdaftar
  const deviceIndex = registeredDevices.findIndex(d => d.id === deviceId);
  if (deviceIndex === -1) {
    console.error(`Device ${deviceId} not registered`);
    return false;
  }
  
  const mockData = {
    device_id: deviceId,
    status_type: statusType,
    message: message,
    timestamp: new Date().toISOString()
  };
  
  return updateDeviceStatus(deviceId, mockData);
};

window.getRegisteredDevices = function() {
  return registeredDevices.map(d => d.id);
};

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', function() {
  // Load configurations
  loadConfig();
  loadDevices();
  
  // Setup device monitoring
  setupDeviceWebhookListener();
  
  // Auto-refresh device table setiap 5 detik
  setInterval(updateDeviceTable, 5000);
  
  // Load rambu data jika config ada
  if (GITHUB_USER && GITHUB_REPO) {
    loadData();
  }
});
  </script>
</body>
</html>
