<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö¶ Rambu Database Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 2px solid #3498db;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #2c3e50;
            background: white;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Rambu Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f5f7fa;
        }

        /* Device Monitoring */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .device-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .device-card.online {
            border-left-color: #2ecc71;
        }

        .device-card.offline {
            border-left-color: #e74c3c;
            opacity: 0.7;
        }

        .device-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .device-info {
            margin: 10px 0;
        }

        .device-info span {
            display: block;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .device-info strong {
            color: #2c3e50;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d35400;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Statistics */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            display: block;
        }

        .stat-card .label {
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Map */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-overspeed {
            background: #fff3cd;
            color: #856404;
        }

        /* Action buttons in table */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .toggle-btn {
            background: #f39c12;
            color: white;
        }
    </style>
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¶ Rambu Database Management</h1>
            <p>Centralized control for 300+ rambu across 20 vehicles</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="showTab('rambu')">üìç Rambu Data (300+)</div>
            <div class="tab" onclick="showTab('devices')">üöó Devices (20)</div>
            <div class="tab" onclick="showTab('map')">üó∫Ô∏è Live Map</div>
            <div class="tab" onclick="showTab('updates')">üîÑ Updates</div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <h2>System Overview</h2>
            
            <div class="stats-container">
                <div class="stat-card">
                    <span class="number" id="totalRambu">0</span>
                    <span class="label">Total Rambu</span>
                </div>
                <div class="stat-card">
                    <span class="number" id="onlineDevices">0</span>
                    <span class="label">Online Devices</span>
                </div>
                <div class="stat-card">
                    <span class="number" id="activeAlerts">0</span>
                    <span class="label">Active Alerts</span>
                </div>
                <div class="stat-card">
                    <span class="number" id="dataVersion">1</span>
                    <span class="label">Data Version</span>
                </div>
            </div>

            <div style="margin: 30px 0;">
                <button class="btn btn-primary" onclick="refreshAllData()">
                    üîÑ Refresh All Data
                </button>
                <button class="btn btn-success" onclick="exportAllData()">
                    üì• Export All Data
                </button>
                <button class="btn btn-warning" onclick="showImportModal()">
                    üì§ Import Data
                </button>
                <button class="btn btn-danger" onclick="pushUpdateToAll()">
                    üöÄ Push Update to All Devices
                </button>
            </div>

            <h3>Recent Activity</h3>
            <div id="activityLog" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                Loading activity log...
            </div>
        </div>

        <!-- Rambu Data Tab -->
        <div id="rambuTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Rambu Database (300+)</h2>
                <button class="btn btn-success" onclick="showAddRambuModal()">
                    ‚ûï Add New Rambu
                </button>
            </div>

            <div style="margin-bottom: 20px;">
                <input type="text" id="searchRambu" placeholder="üîç Search rambu..." 
                       style="padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 5px;">
                <select id="filterJalur" style="padding: 10px; margin-left: 10px;">
                    <option value="all">All Jalur</option>
                    <option value="0">Muatan</option>
                    <option value="1">Kosongan</option>
                    <option value="2">Luar Area</option>
                </select>
                <button class="btn btn-primary" onclick="filterRambuTable()">Filter</button>
            </div>

            <div class="table-container">
                <table id="rambuTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama Area</th>
                            <th>Longitude</th>
                            <th>Latitude</th>
                            <th>Speed Limit</th>
                            <th>Radius (m)</th>
                            <th>Jalur</th>
                            <th>Checkpoint</th>
                            <th>Enabled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <div id="pagination" class="pagination">
                    <!-- Pagination will be generated here -->
                </div>
            </div>
        </div>

        <!-- Devices Tab -->
        <div id="devicesTab" class="tab-content">
            <h2>Device Monitoring (20 Vehicles)</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="refreshDevices()">
                    üîÑ Refresh Device Status
                </button>
                <button class="btn btn-warning" onclick="sendBroadcastMessage()">
                    üì¢ Send Broadcast Message
                </button>
            </div>

            <div class="devices-grid" id="devicesGrid">
                <!-- Device cards will be populated here -->
            </div>
        </div>

        <!-- Map Tab -->
        <div id="mapTab" class="tab-content">
            <h2>Live Vehicle Tracking</h2>
            <div id="map"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="refreshMap()">
                    üîÑ Refresh Map
                </button>
                <button class="btn btn-success" onclick="centerMap()">
                    üéØ Center Map
                </button>
                <span style="margin-left: 20px; color: #666;">
                    Last update: <span id="mapLastUpdate">Never</span>
                </span>
            </div>
            
            <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h4>Legend</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div><span style="color: #2ecc71;">‚óè</span> Online</div>
                    <div><span style="color: #e74c3c;">‚óè</span> Offline</div>
                    <div><span style="color: #f39c12;">‚óè</span> Overspeed</div>
                    <div><span style="color: #3498db;">üìç</span> Rambu Location</div>
                </div>
            </div>
        </div>

        <!-- Updates Tab -->
        <div id="updatesTab" class="tab-content">
            <h2>System Updates & Logs</h2>
            
            <div style="margin-bottom: 30px;">
                <h3>Update History</h3>
                <div id="updateHistory" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    Loading update history...
                </div>
            </div>

            <div>
                <h3>Manual Update</h3>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>‚ö†Ô∏è Warning:</strong> This will update the data version and trigger all devices to download new data.</p>
                </div>
                
                <div class="form-group">
                    <label for="updateMessage">Update Message:</label>
                    <input type="text" id="updateMessage" placeholder="Describe this update..." 
                           style="width: 100%; padding: 10px; margin-bottom: 10px;">
                </div>
                
                <button class="btn btn-danger" onclick="createNewVersion()">
                    üöÄ Create New Version
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Rambu Modal -->
    <div id="rambuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Rambu</h2>
                <button onclick="closeModal()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            
            <form id="rambuForm">
                <input type="hidden" id="rambuIndex" value="-1">
                
                <div class="form-group">
                    <label for="rambuName">Nama Area:</label>
                    <input type="text" id="rambuName" required placeholder="e.g., RANGGA_MUATAN">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="rambuLon">Longitude:</label>
                        <input type="number" id="rambuLon" step="0.000001" required placeholder="117.4938900">
                    </div>
                    <div class="form-group">
                        <label for="rambuLat">Latitude:</label>
                        <input type="number" id="rambuLat" step="0.000001" required placeholder="2.1534910">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="rambuLimit">Speed Limit (km/h):</label>
                        <input type="number" id="rambuLimit" min="10" max="120" value="30" required>
                    </div>
                    <div class="form-group">
                        <label for="rambuRadius">Radius (meters):</label>
                        <input type="number" id="rambuRadius" min="50" max="4000" value="100" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="rambuJalur">Jalur:</label>
                        <select id="rambuJalur" required>
                            <option value="0">Muatan</option>
                            <option value="1">Kosongan</option>
                            <option value="2">Luar Area</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rambuCheckpoint">Checkpoint:</label>
                        <input type="number" id="rambuCheckpoint" min="0" max="99" value="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rambuEnabled">Enabled:</label>
                    <select id="rambuEnabled">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn" onclick="closeModal()" style="background: #95a5a6; color: white;">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Rambu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Data</h2>
                <button onclick="closeImportModal()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            
            <p>Paste CSV data (format: lon,lat,name,limit,radius,jalur,checkpoint,enabled):</p>
            <textarea id="importData" rows="15" style="width: 100%; font-family: monospace; padding: 10px;"></textarea>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="closeImportModal()" style="background: #95a5a6; color: white;">Cancel</button>
                <button class="btn btn-success" onclick="processImport()">Import Data</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS for map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let rambuData = [];
        let devicesData = {};
        let currentPage = 1;
        const itemsPerPage = 50;
        let map = null;
        let markers = [];
        let rambuMarkers = [];

        // GitHub configuration
        const GITHUB_USER = 'yourusername';
        const GITHUB_REPO = 'rambu-database';
        const GITHUB_TOKEN = 'ghp_your_token_here';
        const GITHUB_API = 'https://api.github.com';
        
        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'rambu':
                    loadRambuData();
                    break;
                case 'devices':
                    loadDevices();
                    break;
                case 'map':
                    initMap();
                    break;
                case 'updates':
                    loadUpdateHistory();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const [rambuResponse, devicesResponse, versionResponse] = await Promise.all([
                    fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`),
                    fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/devices-status`, {
                        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                    }),
                    fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`)
                ]);

                const rambuJson = await rambuResponse.json();
                const devicesJson = await devicesResponse.json();
                const version = await versionResponse.text();

                // Update stats
                document.getElementById('totalRambu').textContent = rambuJson.rambu.length;
                document.getElementById('dataVersion').textContent = version.trim();

                // Count online devices
                let onlineCount = 0;
                let alertCount = 0;
                
                for (const device of devicesJson) {
                    if (device.name.endsWith('.json')) {
                        const deviceResponse = await fetch(device.download_url);
                        const deviceData = await deviceResponse.json();
                        
                        if (deviceData.online) {
                            onlineCount++;
                            if (deviceData.overspeed) {
                                alertCount++;
                            }
                        }
                    }
                }

                document.getElementById('onlineDevices').textContent = onlineCount;
                document.getElementById('activeAlerts').textContent = alertCount;

                // Load activity log
                loadActivityLog();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Failed to load dashboard data', false);
            }
        }

        // Load rambu data
        async function loadRambuData() {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rambu-data.json`);
                rambuData = (await response.json()).rambu;
                
                renderRambuTable();
                updatePagination();
                
            } catch (error) {
                console.error('Error loading rambu data:', error);
                showNotification('Failed to load rambu data', false);
            }
        }

        // Render rambu table
        function renderRambuTable() {
            const tableBody = document.querySelector('#rambuTable tbody');
            tableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, rambuData.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const rambu = rambuData[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${rambu.nama}</td>
                    <td>${rambu.lon.toFixed(6)}</td>
                    <td>${rambu.lat.toFixed(6)}</td>
                    <td>${rambu.limit}</td>
                    <td>${rambu.radius}</td>
                    <td>${getJalurName(rambu.jalur)}</td>
                    <td>${rambu.checkpoint}</td>
                    <td>${rambu.enabled ? '‚úì' : '‚úó'}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editRambu(${i})">Edit</button>
                        <button class="action-btn toggle-btn" onclick="toggleRambu(${i})">${rambu.enabled ? 'Disable' : 'Enable'}</button>
                        <button class="action-btn delete-btn" onclick="deleteRambu(${i})">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
        }

        function getJalurName(jalurCode) {
            switch(jalurCode) {
                case 0: return 'Muatan';
                case 1: return 'Kosongan';
                case 2: return 'Luar Area';
                default: return 'Unknown';
            }
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(rambuData.length / itemsPerPage);
            const paginationDiv = document.getElementById('pagination');
            
            let html = '';
            
            if (currentPage > 1) {
                html += `<button class="btn" onclick="changePage(${currentPage - 1})">Previous</button> `;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-primary" style="margin: 0 5px;">${i}</button> `;
                } else {
                    html += `<button class="btn" onclick="changePage(${i})" style="margin: 0 5px;">${i}</button> `;
                }
            }
            
            if (currentPage < totalPages) {
                html += `<button class="btn" onclick="changePage(${currentPage + 1})">Next</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderRambuTable();
            updatePagination();
        }

        function filterRambuTable() {
            const searchTerm = document.getElementById('searchRambu').value.toLowerCase();
            const filterJalur = document.getElementById('filterJalur').value;
            
            const filteredData = rambuData.filter(rambu => {
                const matchesSearch = rambu.nama.toLowerCase().includes(searchTerm) ||
                                    rambu.lon.toString().includes(searchTerm) ||
                                    rambu.lat.toString().includes(searchTerm);
                
                const matchesJalur = filterJalur === 'all' || rambu.jalur.toString() === filterJalur;
                
                return matchesSearch && matchesJalur;
            });
            
            // Create a temporary filtered array for display
            const tempData = [...filteredData];
            currentPage = 1;
            renderFilteredTable(tempData);
        }

        function renderFilteredTable(data) {
            const tableBody = document.querySelector('#rambuTable tbody');
            tableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, data.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const rambu = data[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${rambu.nama}</td>
                    <td>${rambu.lon.toFixed(6)}</td>
                    <td>${rambu.lat.toFixed(6)}</td>
                    <td>${rambu.limit}</td>
                    <td>${rambu.radius}</td>
                    <td>${getJalurName(rambu.jalur)}</td>
                    <td>${rambu.checkpoint}</td>
                    <td>${rambu.enabled ? '‚úì' : '‚úó'}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editRambu(${rambuData.indexOf(rambu)})">Edit</button>
                        <button class="action-btn toggle-btn" onclick="toggleRambu(${rambuData.indexOf(rambu)})">${rambu.enabled ? 'Disable' : 'Enable'}</button>
                        <button class="action-btn delete-btn" onclick="deleteRambu(${rambuData.indexOf(rambu)})">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            updatePaginationForFiltered(data);
        }

        function updatePaginationForFiltered(data) {
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const paginationDiv = document.getElementById('pagination');
            
            let html = '';
            
            if (currentPage > 1) {
                html += `<button class="btn" onclick="changePageForFiltered(${currentPage - 1}, ${JSON.stringify(data)})">Previous</button> `;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-primary" style="margin: 0 5px;">${i}</button> `;
                } else {
                    html += `<button class="btn" onclick="changePageForFiltered(${i}, ${JSON.stringify(data)})" style="margin: 0 5px;">${i}</button> `;
                }
            }
            
            if (currentPage < totalPages) {
                html += `<button class="btn" onclick="changePageForFiltered(${currentPage + 1}, ${JSON.stringify(data)})">Next</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        function changePageForFiltered(page, data) {
            currentPage = page;
            renderFilteredTable(JSON.parse(data));
        }

        // Load devices
        async function loadDevices() {
            try {
                const response = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/devices-status`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                
                const devices = await response.json();
                const devicesGrid = document.getElementById('devicesGrid');
                devicesGrid.innerHTML = '';
                
                for (const device of devices) {
                    if (device.name.endsWith('.json')) {
                        const deviceResponse = await fetch(device.download_url);
                        const deviceData = await deviceResponse.json();
                        
                        const deviceId = device.name.replace('.json', '');
                        devicesData[deviceId] = deviceData;
                        
                        const card = document.createElement('div');
                        card.className = `device-card ${deviceData.online ? 'online' : 'offline'}`;
                        
                        card.innerHTML = `
                            <h3>${deviceId}</h3>
                            <div class="device-info">
                                <span>Status: <strong>${deviceData.online ? 'Online' : 'Offline'}</strong></span>
                                <span>Last Seen: ${deviceData.timestamp || 'Never'}</span>
                                <span>Location: ${deviceData.latitude ? deviceData.latitude.toFixed(6) + ', ' + deviceData.longitude.toFixed(6) : 'Unknown'}</span>
                                <span>Speed: ${deviceData.speed || 0} km/h</span>
                                <span>Near: ${deviceData.nearest_rambu || 'None'}</span>
                                <span>Limit: ${deviceData.current_limit || 70} km/h</span>
                                <span>Overspeed: ${deviceData.overspeed ? '‚ö†Ô∏è YES' : '‚úì No'}</span>
                                <span>Satellites: ${deviceData.satellites || 0}</span>
                                <span>Data Version: ${deviceData.data_version || 'Unknown'}</span>
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-primary" onclick="sendMessageToDevice('${deviceId}')" ${!deviceData.online ? 'disabled' : ''}>
                                    Send Message
                                </button>
                            </div>
                        `;
                        
                        devicesGrid.appendChild(card);
                    }
                }
                
            } catch (error) {
                console.error('Error loading devices:', error);
                showNotification('Failed to load devices data', false);
            }
        }

        // Initialize map
        function initMap() {
            if (!map) {
                map = L.map('map').setView([2.15, 117.49], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            rambuMarkers.forEach(marker => map.removeLayer(marker));
            rambuMarkers = [];
            
            // Add rambu markers
            rambuData.forEach(rambu => {
                if (rambu.enabled) {
                    const rambuMarker = L.marker([rambu.lat, rambu.lon])
                        .bindPopup(`
                            <strong>${rambu.nama}</strong><br>
                            Limit: ${rambu.limit} km/h<br>
                            Radius: ${rambu.radius} m<br>
                            Jalur: ${getJalurName(rambu.jalur)}<br>
                            Checkpoint: ${rambu.checkpoint}
                        `);
                    
                    rambuMarkers.push(rambuMarker);
                    rambuMarker.addTo(map);
                }
            });
            
            // Add device markers
            Object.keys(devicesData).forEach(deviceId => {
                const device = devicesData[deviceId];
                
                if (device.online && device.latitude && device.longitude) {
                    const color = device.overspeed ? '#f39c12' : (device.online ? '#2ecc71' : '#e74c3c');
                    
                    const deviceMarker = L.marker([device.latitude, device.longitude], {
                        icon: L.divIcon({
                            className: 'device-marker',
                            html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                            iconSize: [24, 24]
                        })
                    }).bindPopup(`
                        <strong>${deviceId}</strong><br>
                        Speed: ${device.speed} km/h<br>
                        Heading: ${device.heading || 0}¬∞<br>
                        Near: ${device.nearest_rambu || 'None'}<br>
                        Status: ${device.overspeed ? '‚ö†Ô∏è OVERSPEED' : 'Normal'}<br>
                        Time: ${device.timestamp}
                    `);
                    
                    markers.push(deviceMarker);
                    deviceMarker.addTo(map);
                }
            });
            
            document.getElementById('mapLastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function refreshMap() {
            if (map) {
                initMap();
            }
        }

        function centerMap() {
            if (map && markers.length > 0) {
                const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
                map.fitBounds(bounds);
            }
        }

        // Modal functions
        function showAddRambuModal() {
            document.getElementById('modalTitle').textContent = 'Add New Rambu';
            document.getElementById('rambuIndex').value = '-1';
            document.getElementById('rambuForm').reset();
            document.getElementById('rambuJalur').value = '0';
            document.getElementById('rambuEnabled').value = 'true';
            document.getElementById('rambuCheckpoint').value = '1';
            document.getElementById('rambuModal').style.display = 'flex';
        }

        function editRambu(index) {
            const rambu = rambuData[index];
            
            document.getElementById('modalTitle').textContent = 'Edit Rambu';
            document.getElementById('rambuIndex').value = index;
            document.getElementById('rambuName').value = rambu.nama;
            document.getElementById('rambuLon').value = rambu.lon;
            document.getElementById('rambuLat').value = rambu.lat;
            document.getElementById('rambuLimit').value = rambu.limit;
            document.getElementById('rambuRadius').value = rambu.radius;
            document.getElementById('rambuJalur').value = rambu.jalur;
            document.getElementById('rambuCheckpoint').value = rambu.checkpoint;
            document.getElementById('rambuEnabled').value = rambu.enabled.toString();
            
            document.getElementById('rambuModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('rambuModal').style.display = 'none';
        }

        // Handle form submission
        document.getElementById('rambuForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('rambuIndex').value);
            const isNew = index === -1;
            
            const rambu = {
                lon: parseFloat(document.getElementById('rambuLon').value),
                lat: parseFloat(document.getElementById('rambuLat').value),
                nama: document.getElementById('rambuName').value,
                limit: parseInt(document.getElementById('rambuLimit').value),
                radius: parseInt(document.getElementById('rambuRadius').value),
                jalur: parseInt(document.getElementById('rambuJalur').value),
                checkpoint: parseInt(document.getElementById('rambuCheckpoint').value),
                enabled: document.getElementById('rambuEnabled').value === 'true'
            };
            
            if (isNew) {
                rambuData.push(rambu);
            } else {
                rambuData[index] = rambu;
            }
            
            // Save to GitHub
            try {
                await saveRambuDataToGitHub();
                showNotification(`Rambu ${isNew ? 'added' : 'updated'} successfully!`);
                closeModal();
                renderRambuTable();
                updatePagination();
            } catch (error) {
                showNotification('Failed to save to GitHub', false);
                console.error(error);
            }
        });

        async function saveRambuDataToGitHub() {
            // Get current file SHA
            const getResponse = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            
            const getData = await getResponse.json();
            const sha = getData.sha;
            
            // Prepare update data
            const updateData = {
                rambu: rambuData,
                last_updated: new Date().toISOString(),
                total_count: rambuData.length
            };
            
            const content = btoa(JSON.stringify(updateData, null, 2));
            
            // Update file
            const updateResponse = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/rambu-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Update rambu data via admin dashboard',
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateResponse.ok) {
                throw new Error('Failed to update GitHub');
            }
        }

        async function toggleRambu(index) {
            rambuData[index].enabled = !rambuData[index].enabled;
            
            try {
                await saveRambuDataToGitHub();
                showNotification(`Rambu ${rambuData[index].enabled ? 'enabled' : 'disabled'} successfully!`);
                renderRambuTable();
            } catch (error) {
                showNotification('Failed to update rambu', false);
                console.error(error);
            }
        }

        async function deleteRambu(index) {
            if (!confirm(`Are you sure you want to delete "${rambuData[index].nama}"?`)) {
                return;
            }
            
            rambuData.splice(index, 1);
            
            try {
                await saveRambuDataToGitHub();
                showNotification('Rambu deleted successfully!');
                loadRambuData(); // Reload data
            } catch (error) {
                showNotification('Failed to delete rambu', false);
                console.error(error);
            }
        }

        // Import/Export functions
        function showImportModal() {
            document.getElementById('importData').value = '';
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        async function processImport() {
            const csvData = document.getElementById('importData').value.trim();
            
            if (!csvData) {
                showNotification('Please enter CSV data', false);
                return;
            }
            
            const lines = csvData.split('\n');
            const importedRambu = [];
            
            // Skip header if present
            const startIndex = lines[0].includes('lon,lat') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const fields = line.split(',');
                if (fields.length >= 6) {
                    const rambu = {
                        lon: parseFloat(fields[0]),
                        lat: parseFloat(fields[1]),
                        nama: fields[2],
                        limit: parseInt(fields[3]),
                        radius: parseInt(fields[4]),
                        jalur: parseInt(fields[5]),
                        checkpoint: fields.length > 6 ? parseInt(fields[6]) : 0,
                        enabled: fields.length > 7 ? (fields[7] === '1' || fields[7].toLowerCase() === 'true') : true
                    };
                    
                    importedRambu.push(rambu);
                }
            }
            
            if (importedRambu.length > 0) {
                // Replace existing data with imported data
                rambuData = importedRambu;
                
                try {
                    await saveRambuDataToGitHub();
                    showNotification(`Imported ${importedRambu.length} rambu successfully!`);
                    closeImportModal();
                    loadRambuData();
                } catch (error) {
                    showNotification('Failed to save imported data', false);
                    console.error(error);
                }
            } else {
                showNotification('No valid data found in CSV', false);
            }
        }

        function exportAllData() {
            const data = {
                rambu: rambuData,
                exported_at: new Date().toISOString(),
                total_count: rambuData.length
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `rambu_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!');
        }

        // Update functions
        async function createNewVersion() {
            const message = document.getElementById('updateMessage').value.trim();
            if (!message) {
                showNotification('Please enter an update message', false);
                return;
            }
            
            // Get current version
            const versionResponse = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/version.txt`);
            let currentVersion = parseInt(await versionResponse.text()) || 1;
            
            // Increment version
            currentVersion++;
            
            // Update version file
            try {
                // Get current SHA
                const getResponse = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                
                const getData = await getResponse.json();
                const sha = getData.sha;
                
                // Update version
                await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/version.txt`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Version ${currentVersion}: ${message}`,
                        content: btoa(currentVersion.toString()),
                        sha: sha
                    })
                });
                
                // Create update log
                const updateLog = {
                    version: currentVersion,
                    message: message,
                    timestamp: new Date().toISOString(),
                    rambu_count: rambuData.length,
                    updated_by: 'Admin Dashboard'
                };
                
                const logContent = btoa(JSON.stringify(updateLog, null, 2));
                const logFileName = `update_${currentVersion}_${new Date().toISOString().slice(0, 10)}.json`;
                
                await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/update-log/${logFileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update log for version ${currentVersion}`,
                        content: logContent
                    })
                });
                
                showNotification(`New version ${currentVersion} created! All devices will update on next check.`);
                document.getElementById('updateMessage').value = '';
                loadUpdateHistory();
                
            } catch (error) {
                showNotification('Failed to create new version', false);
                console.error(error);
            }
        }

        async function loadUpdateHistory() {
            try {
                const response = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/update-log`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                
                const files = await response.json();
                const updateHistoryDiv = document.getElementById('updateHistory');
                updateHistoryDiv.innerHTML = '';
                
                // Sort files by name (newest first)
                files.sort((a, b) => b.name.localeCompare(a.name));
                
                for (const file of files.slice(0, 10)) { // Show last 10 updates
                    if (file.name.endsWith('.json')) {
                        const fileResponse = await fetch(file.download_url);
                        const updateData = await fileResponse.json();
                        
                        const updateDiv = document.createElement('div');
                        updateDiv.style.padding = '10px';
                        updateDiv.style.borderBottom = '1px solid #ddd';
                        updateDiv.style.marginBottom = '5px';
                        
                        updateDiv.innerHTML = `
                            <strong>Version ${updateData.version}</strong><br>
                            <small>${new Date(updateData.timestamp).toLocaleString()}</small><br>
                            ${updateData.message}<br>
                            <small>Rambu: ${updateData.rambu_count} | By: ${updateData.updated_by}</small>
                        `;
                        
                        updateHistoryDiv.appendChild(updateDiv);
                    }
                }
                
            } catch (error) {
                console.error('Error loading update history:', error);
                document.getElementById('updateHistory').innerHTML = 'Failed to load update history';
            }
        }

        // Utility functions
        function showNotification(message, isSuccess = true) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px 20px';
            notification.style.backgroundColor = isSuccess ? '#2ecc71' : '#e74c3c';
            notification.style.color = 'white';
            notification.style.borderRadius = '5px';
            notification.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            notification.style.zIndex = '1000';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        function refreshAllData() {
            loadDashboard();
            loadRambuData();
            loadDevices();
            if (map) initMap();
            showNotification('All data refreshed!');
        }

        function refreshDevices() {
            loadDevices();
            showNotification('Devices refreshed!');
        }

        async function loadActivityLog() {
            try {
                // Get recent device status updates
                const response = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/devices-status`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                
                const files = await response.json();
                const activityLog = document.getElementById('activityLog');
                activityLog.innerHTML = '';
                
                // Sort by date (newest first)
                const sortedFiles = files
                    .filter(f => f.name.endsWith('.json'))
                    .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
                    .slice(0, 5); // Show last 5 activities
                
                for (const file of sortedFiles) {
                    const fileResponse = await fetch(file.download_url);
                    const deviceData = await fileResponse.json();
                    
                    const activityDiv = document.createElement('div');
                    activityDiv.style.padding = '5px 0';
                    activityDiv.style.borderBottom = '1px solid #eee';
                    
                    const deviceId = file.name.replace('.json', '');
                    const status = deviceData.online ? 'Online' : 'Offline';
                    const overspeed = deviceData.overspeed ? ' ‚ö†Ô∏è OVERSPEED' : '';
                    
                    activityDiv.innerHTML = `
                        <strong>${deviceId}</strong>: ${status}${overspeed} 
                        <small style="float: right;">${deviceData.timestamp || 'Unknown time'}</small><br>
                        <small>${deviceData.nearest_rambu || 'No rambu nearby'}</small>
                    `;
                    
                    activityLog.appendChild(activityDiv);
                }
                
            } catch (error) {
                console.error('Error loading activity log:', error);
                document.getElementById('activityLog').innerHTML = 'Failed to load activity log';
            }
        }

        async function pushUpdateToAll() {
            if (!confirm('This will force all devices to check for updates. Continue?')) {
                return;
            }
            
            showNotification('Pushing update notification to all devices...');
            
            // In a real system, you might use webhooks or MQTT here
            // For GitHub-based system, devices check automatically on interval
            
            // Just update version to force check
            await createNewVersion();
        }

        async function sendMessageToDevice(deviceId) {
            const message = prompt(`Enter message for ${deviceId}:`);
            if (!message) return;
            
            // In a real system, implement device messaging
            showNotification(`Message sent to ${deviceId}: ${message}`);
        }

        function sendBroadcastMessage() {
            const message = prompt('Enter broadcast message for all devices:');
            if (!message) return;
            
            // In a real system, implement broadcast messaging
            showNotification(`Broadcast message sent to all devices: ${message}`);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadDashboard();
            
            // Set up periodic refresh for dashboard
            setInterval(() => {
                if (document.getElementById('dashboardTab').classList.contains('active')) {
                    loadDashboard();
                }
            }, 30000); // Refresh every 30 seconds
            
            // Set up periodic refresh for devices
            setInterval(() => {
                if (document.getElementById('devicesTab').classList.contains('active')) {
                    loadDevices();
                }
            }, 10000); // Refresh every 10 seconds
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
                closeImportModal();
            }
        };
    </script>
</body>
</html>
